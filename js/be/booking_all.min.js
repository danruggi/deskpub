function ckGuests(e){e.classList.toggle("selected"),1==e.querySelector(".checked").hidden?(e.querySelector(".checked").hidden=0,e.querySelector(".unchecked").hidden=1,e.querySelector("input").value="1"):(e.querySelector(".checked").hidden=1,e.querySelector(".unchecked").hidden=0,e.querySelector("input").value="")}function undoCk(e,t){formSubmitXML(e,"booking_ck_undo")}function deleteBooking(e){console.log(e),confirm("Are you sure you want to delete booking "+bid+"?")&&formSubmitXML(e,"booking_delete")}function deleteCustomer(e){formSubmitXML(e,"booking_customer_delete")}function buttonCostsClick(){document.querySelector("button[name='but_costs']").click()}function buttonPaymentsClick(){document.querySelector("button[name='but_payments']").click()}function showAllCosts(){setCookie("show_all_costs",1,.001),location.reload()}function xtraServiceSelect(e){var t=e.selectedIndex,t=e.options[t].attributes.alt.value;let n=getParentByClass(e,"xtraForm"),o=n.querySelector("input[name=amount]");0==o.value.length&&(o.value=t)}function returnableDepositSelect(e){let t=getParentByClass(e,"parentForm"),n=t.querySelector("select");e=n.selectedIndex;let o=0,s=(n.options[e].hasAttribute("alt")&&(o=n.options[e].attributes.alt.value),t.querySelector("input[name=amount]"));e=t.querySelector("input[name=num]").value;let l=t.querySelector("input[name=total]");s.value=o,l.value=o*e}function depositReturn(e){let t=new FormData;t.append("bid",bid),t.append("did",e),t.append("q","booking_deposit_return"),postFetch(t)}function depositConvertToPayment(e,t){let n=new FormData;n.append("bid",bid),n.append("did",e),n.append("total",t),dep_name=document.getElementById("li_deposit_"+e).querySelector(".deposit-name").innerText,n.append("dep_name",dep_name),n.append("q","booking_deposit_to_payment"),postFetch(n)}function loadCustomersDetails(e){arr="&bid="+e,postHttpReq("booking_details_get",arr)}function loadNotes(e){arr="&bid="+bid,note_category=e,postHttpReq("booking_note_get_all",arr)}function deleteNote(e,t){let n=new FormData;n.append("bid",t),n.append("nid",e),n.append("q","booking_note_delete"),postFetch(n)}function setNoteAsRead(e){let t=document.getElementById("note_"+e),n=document.getElementById("booking_notes_result").querySelector(".res-"+e+" span.read-time"),o=(1==note_category&&(n=document.getElementById("booking_alerts_result").querySelector(".res-"+e+" span.read-time")),new FormData);o.append("bid",bid),o.append("nid",e),o.append("q","booking_note_set_read"),t.classList.contains("to-read")&&(t.classList.remove("to-read"),n.innerText="Read now",postFetch(o))}function setNoteAsUnread(e){let t=document.getElementById("note_"+e),n=document.getElementById("booking_notes_result").querySelector(".res-"+e+" span.read-time"),o=(1==note_category&&(n=document.getElementById("booking_alerts_result").querySelector(".res-"+e+" span.read-time")),new FormData);o.append("bid",bid),o.append("nid",e),o.append("q","booking_note_set_unread"),t.classList.add("to-read"),n.innerText="Unread",postFetch(o)}function setNoteAsSolved(e){let t=document.getElementById("note_"+e),n=document.getElementById("booking_alerts_result");t.querySelector("span.cidname");let o=n.querySelector("span.solved-time");n.querySelector("span.solved-user");let s=n.querySelector("button[name='solved-button']"),l=t.querySelector("span.unsolved"),a=new FormData;a.append("bid",bid),a.append("nid",e),a.append("q","booking_note_set_solved"),t.classList.contains("to-solve")&&(t.classList.remove("to-solve"),o.innerText="Solved now",s.classList.remove("red"),s.classList.add("dgreen"),l.classList.add("hidden"),postFetch(a))}function displayNote(e){let t,n;t=0==note_category?(n=document.getElementById("booking_notes_list"),t=document.getElementById("booking_notes_result")):(n=document.getElementById("booking_alerts_list"),document.getElementById("booking_alerts_result")),n.querySelectorAll("li").forEach(function(e){e.classList.remove("selected")}),document.getElementById("note_"+e).classList.add("selected"),console.log("hide all note results and show "+e+" note in target "+t.id),t.querySelectorAll(".note-result").forEach(function(e){e.classList.add("hidden")}),t.querySelector(".res-"+e).classList.remove("hidden")}function countUnreadNotes(){let e;var t;let n;0==note_category?(e=document.getElementById("booking_notes_list"),n=document.getElementById("has_notes_to_read")):(e=document.getElementById("booking_alerts_list"),n=document.getElementById("has_alerts_to_read"),alerts_to_solve=Array.from(e.querySelectorAll("li.to-solve")).length),t=Array.from(e.querySelectorAll("li.to-read")).length,console.log(t),0<t?n.classList.remove("hidden"):n.classList.add("hidden")}function generateNewQrCodeFileUpload(t,e){if(0==arguments.length){let e=new FormData;return e.append("bid",bid),e.append("q","booking_details_new_qr_link"),void fetch("/servers/bookingDetails.php",{method:"POST",body:e}).then(e=>e.json()).then(e=>{console.log(e),e.hasOwnProperty("e")?(error=!0,showMessage(!1,e.m,3)):(e=e.hash,t="https://www.deskydoo.com/workspace/phoneUpload.php?h="+e+"&bid="+bid,console.log(t),generateNewQrCodeFileUpload(t,e))})}let n=document.getElementById("qrcode_file_upload"),o=n.querySelector(".qrcodeImage"),s=n.querySelector(".timer"),l=n.querySelector(".qrtitle");var a=e;o.innerHTML="",s.innerHTML="",l.classList.remove("hidden"),qrcode=new QRCode(o,{text:t,width:128,height:128});let i=document.createElement("span"),r=document.createElement("span"),d=60,c=(r.classList.add("small"),r.innerHTML="Link valid ",i.innerHTML="60 s",r.append(i),s.append(r),clearInterval(qrtimers.valid),qrtimers.valid=setInterval(function(){if(d--,i.innerHTML=d+" s",d<=0){o.innerHTML="",s.innerHTML="";let e=document.createElement("button");e.type="button",e.classList.add("bs","small","yellow"),e.innerHTML="Generate New QR Code",o.append(e),e.addEventListener("click",function(){generateNewQrCodeFileUpload()}),console.log("expired"),clearInterval(qrtimers.valid),clearInterval(qrtimers.connected)}},1e3),0),u=new FormData;u.append("bid",bid),u.append("hash",a),u.append("q","booking_details_get_link_state"),clearInterval(qrtimers.connected),qrtimers.connected=setInterval(function(){fetch("/servers/bookingDetails.php",{method:"POST",body:u}).then(e=>e.json()).then(e=>{if(e.hasOwnProperty("state")){let t=e.state;if(1==t)t!=c&&(c=t,clearInterval(qrtimers.valid),o.innerHTML="",s.innerHTML="",l.classList.add("hidden"),e=prepareStateContainer("/assets/icons/phone-cloud.svg","Phone connected","filter-green","160",!0),n.append(e));else if(2==t){if(t!=c){c=t;let e=n.querySelector(".state-container");e.parentNode.removeChild(e),e=prepareStateContainer("/assets/logo300_square_d.gif","Uploading File","none","120",!0),n.append(e)}}else if(9==t){if(t!=c){c=t;let e=n.querySelector(".state-container");e.parentNode.removeChild(e),e=prepareStateContainer("/assets/icons/check-solid.svg","File Uploaded","filter-green","100",!1),n.append(e),clearInterval(qrtimers.connected),clearInterval(qrtimers.valid),setTimeout(function(){setPopupDetailsBookingImage(),e.parentNode.removeChild(e)},2e3)}}else if(-1==t){c=t,console.log(t),showMessage(!1,"Error uploading file");let e=n.querySelector(".state-container");e.parentNode.removeChild(e),e=prepareStateContainer("/assets/icons/times-solid.svg","Error Uploading","filter-dred","100",!0),n.append(e),clearInterval(qrtimers.connected),clearInterval(qrtimers.valid)}else t=0}})},2e3),console.log(">>>"+t)}function prepareStateContainer(e,t,n,o,s){let l=document.createElement("div"),a=document.createElement("img"),i=document.createElement("h3"),r=document.createElement("button");return l.classList.add("state-container","flex-container","flex-col"),a.width=o,a.height=o,a.classList.add(n,"m0a"),i.classList.add("tgreen","m0"),r.classList.add("bs","transparent","small","tcoral"),r.type="button",r.innerHTML="Cancel",l.append(a),l.append(i),s&&l.append(r),a.src=e,i.innerHTML=t,r.addEventListener("click",function(e){clearInterval(qrtimers.connected),l.parentNode.removeChild(l),generateNewQrCodeFileUpload(),e.stopPropagation()}),l}function setPopupDetailsBookingImage(){let e=new FormData;e.append("bid",bid),e.append("q","booking_details_get_file_name"),fetch("/servers/bookingDetails.php",{method:"POST",body:e}).then(e=>e.json()).then(e=>{e.hasOwnProperty("name")?(e=e.name,booking_file_name=e,uploadImageControl("showPreview",e),console.log(e)):generateNewQrCodeFileUpload()})}function showBottomSection(e){let t=e.attributes.name.value;var n="bottom_"+t.replace("but_","");let o=document.getElementById(n);var s="&bid="+bid;if("bottom_costs"==n)postHttpReq("booking_bottom_costs",s);else if("bottom_history"==n){let e=new FormData;e.append("bid",bid),e.append("q","booking_bottom_history"),postFetch(e)}document.querySelectorAll(".bottom-section").forEach(function(e){e.classList.add("hidden")}),o.classList.toggle("hidden"),e.scrollIntoView({behavior:"smooth"}),console.log(n)}function showBookingImagePopup(){let e=document.getElementById("popup_booking_assoc_image");e.style.backgroundImage="url("+booking_file_name+")",closePopup(),console.log("ok showing"),showPopup("popout_images")}function deleteBookingImage(){let e=new FormData;e.append("bid",bid),e.append("q","booking_details_delete_file_name"),postFetch(e)}function printInvoice(){let e=document.createElement("div");e.classList.add("to-print");var t=document.getElementById("book_top"),t=parseHTML(t);document.body.appendChild(t)}function verifyCheckout(e){let t=e.form,n,o,s={},l=!0,a=document.getElementById("popout_checkout_verify"),i,r=0,d="";for(i=a.querySelector(".hidden-customers-out"),t.querySelectorAll("input").forEach(function(e){console.log(e.name+"--\x3e"+e.value),"bid"==e.name?n=e.value:"state"==e.name?o=e.value:isNaN(e.name)?e.name.startsWith("rb_")&&(d+="<input type='hidden' name='"+e.name+"' value='"+e.value+"'>"):(0==e.value&&(l=!1),s[e.name]=e.value,d+="<input type='hidden' name='"+e.name+"' value='"+e.value+"'>")});i.firstChild;)i.removeChild(i.firstChild);e=parseHTML(d),i.appendChild(e),a.querySelectorAll(".ckout-verify").forEach(function(e){e.querySelector("img.ckout-forced").classList.add("hidden"),e.querySelector("button").classList.remove("hidden")}),a.querySelector("button.toggle_ckout").disabled=1;var c=document.querySelector(".right .live-balance").innerText,c=((i=a.querySelector(".has-balance")).classList.add("hidden"),l&&0<c&&(i.classList.remove("hidden"),r++),document.querySelector(".right .live-deposits").innerText);(i=a.querySelector(".has-deposits")).classList.add("hidden"),l&&0<c&&(i.classList.remove("hidden"),r++),(i=a.querySelector(".has-nights-out")).classList.add("hidden");let u=!(d="<span class='small w100'>"),p;if(p=i.querySelector(".message-section"),document.querySelectorAll("#bottom_guests .total-nights-out").forEach(function(e){var t=e.innerText,n=e.dataset.cid,e=e.dataset.cname;1==s[n]&&(d+="Customer <b>"+e+"</b> spent <span class='big bold tred'>"+t+" </span> nights out<br>",u=!0)}),d+="Confirm that?</span>",u){for(;p.firstChild;)p.removeChild(p.firstChild);e=parseHTML(d),p.appendChild(e),i.classList.remove("hidden"),r++}if((i=a.querySelector(".has-unsolved-alerts")).classList.add("hidden"),0<alerts_to_solve&&l&&(i.querySelector(".alerts-to-solve-num").innerText=alerts_to_solve,i.classList.remove("hidden"),r++),0==r){let e=a.querySelector("button.toggle_ckout");return e.disabled=0,void formSubmitXML(e,"booking_ckout")}console.log("checkout verify"),closePopup(),showPopup("popout_checkout_verify")}function confirmForceCheckout(e){let t=e.form,n=e.parentElement.querySelector("input"),o=e.parentElement.querySelector("img");n.value=1,o.classList.remove("hidden"),e.classList.add("hidden");var e=Array.from(t.querySelectorAll("div.ckout-verify:not(.hidden)")).length,s=Array.from(t.querySelectorAll("img.ckout-forced:not(.hidden)")).length;console.log(e+"--\x3e"+s),s==e&&(t.querySelector("button.toggle_ckout").disabled=0)}function showCustomerDetails(e){let s="",l,a=document.getElementById("popout_details"),i=1;null!==e.details&&(i=e.details[1]),console.log(e),Object.entries(e).forEach(function(t){if(console.log(t),isNaN(t[0])){if("channels"==t[0]){let n="",e=a.querySelector("select[name='bookingChannel']");Object.entries(t[1]).forEach(function(e,t){s="",e[1][0]==i&&(s=" selected"),n+="<option value='"+e[1][0]+"'"+s+">"+e[1][1]+"</option>"});var o=parseHTML(n);e.appendChild(o)}}else l=t[0],dets=mapDetails(t),Object.entries(dets).forEach(function([e,t]){let n=a.querySelector("[name='"+l+"_"+e+"']");n,null!=n&&(n.value=t)})}),setPopupDetailsBookingImage(),showPopup("popout_details")}function mapDetails(e){return out={cat:e[1][1],type:e[1][2],title:e[1][3],email:e[1][5],idtype:e[1][6],idnum:e[1][7],phonenum:e[1][8],street:e[1][9],city:e[1][10],cp:e[1][11],state:e[1][12],country:e[1][13]}}function showBottomExtrasAndDiscounts(e){let n=document.getElementById("bottom_costs").querySelector(".right"),s="<h2>Discounts and Extras</h2>";Array.from(Object.entries(e)).reverse().forEach(function(e){var t=e[1].discounts,o=e[1].extras;if(console.log(o),s=(s+="<ul class='boxlist gray ta-l'>")+("<li class='header'><h2 class='m0'>"+e[0]+"</h2></li>"),null!=t&&Object.entries(t).forEach(function(e){0==e[0]&&(s+="<li class='header'><h5 class='m0 ml1'>Discounts</h5></li>"),s=(s=(s=(s=(s=(s=(s+="<li class=''><form>")+"<input type='hidden' name='bid' value='"+e[1].bid+"'>")+"<input type='hidden' name='id' value='"+e[1].id+"'>\t<button type='button' class='bs transparent flex-container' onclick='formSubmitXML(this, `booking_bottom_delete_discount`)' style='position: absolute; top:50%; right: 0; transform: translate(0, -50%);'>")+" \t<img src='/assets/icons/times-solid.svg' width='12' height='12' class='filter-dred pointer' > </button>")+"</form>\t<div class='flex-container space-between mr2'>")+"\t\t<span>"+e[1].insert_date+"</span>")+"\t\t<span class='tred'><b>-"+e[1].amount+"</b> <span class='small'>"+curr+"</span></span>\t</div>",0<e[1].note.length&&(s+="<div class='ml1 mr1'><i>"+e[1].note+"</i></div>"),s+="</li>"}),null!=o){let n="---";Object.entries(o).forEach(function(e){0==e[0]&&(s+="<li class='header'><h5 class='m0 ml1'>Extras</h5></li>"),null!==e[1].name&&(n=e[1].name);var t=e[1].price*e[1].num;s=(s=(s=(s=(s=(s=(s=(s=(s=(s=(s+="<li class=''><form>")+"<input type='hidden' name='bid' value='"+e[1].bid+"'>")+"<input type='hidden' name='id' value='"+e[1].id+"'>\t<button type='button' class='bs transparent flex-container' onclick='formSubmitXML(this, `booking_bottom_delete_service`)' style='position: absolute; top:50%; right: 0; transform: translate(0, -50%);'>")+" \t<img src='/assets/icons/times-solid.svg' width='12' height='12' class='filter-dred pointer'> </button>")+"</form>\t<div class='flex-container space-between mr2'>")+"\t\t<span>"+e[1].insert_date+"</span>")+"\t\t<span class='tgreen'><b>+"+t+"</b> <span class='small'>"+curr+"</span></span>")+"\t</div>\t<div class='flex-container space-between mr2'>")+"\t\t<span><i>"+n+"</i></span>")+"\t\t<span><i>pax: "+e[1].num+"</i></span>")+"\t</div></li>"})}s+="</ul>";e=parseHTML(s);for(console.log(e);n.firstChild;)n.removeChild(n.firstChild);n.appendChild(e)})}function showBottomHistory(e){let t=document.getElementById("bottom_history").querySelector("ul.history-ul"),n="";n+="<li class='header grid-container grid-4col'><h4>Time</h4><h4>Action</h4><h4>Details</h4><h4>By User</h4></li>",Object.entries(e).forEach(function(e){n=(n=(n=(n=(n+="<li class='grid-container grid-4col'>")+"\t<span>"+e[1].insert_date+"</span>")+"\t<span>"+user_actions[e[1].code]+"</span>")+"\t<span>"+e[1].details+"</span>")+"\t<span>"+e[1].name+"</span></li>"});e=parseHTML(n);for(console.log(e);t.firstChild;)t.removeChild(t.firstChild);t.classList.remove("hidden"),t.appendChild(e)}function showNotes(e){let g=0,b=0,t="popout_notes",y=document.getElementById("booking_notes_list"),v=document.getElementById("booking_notes_result"),n=document.getElementById("notes_numbers"),_="note1-solid.svg";1==note_category&&(t="popout_alerts",y=document.getElementById("booking_alerts_list"),v=document.getElementById("booking_alerts_result"),n=document.getElementById("alerts_numbers"),_="alert-solid.svg");let o=v.parentElement;for(document.querySelectorAll("textarea[name='note']").forEach(function(e){e.value=""});y.firstChild;)y.removeChild(y.firstChild);for(;v.firstChild;)v.removeChild(v.firstChild);console.log(e),Array.from(Object.entries(e)).reverse().forEach(function(e){var t=e[1].cat,n=e[1].read_date,o=e[1].solved_date,s=e[1].nid,l=(e[1].cid,e[1].bid),a=e[1].created_user,i=e[1].read_user,r=e[1].solved_user,d=e[1].insert_date;let c=new Date(e[1].solved_date),u=new Date(e[1].read_date),p=new Date(d);d=new Date,d=parseInt((d-p)/1e3),d=stringFromSeconds(d);let m=xclass="",h="";null===n&&(xclass="to-read"),null===o&&1==note_category&&(xclass+=" to-solve"),t==note_category&&(b++,g++,m=(m=(m=m+("<li id='note_"+s+"' class='top noarrow highlighted "+xclass)+" cat"+t+"'>\t<div class='grid-container no-gap pointer m0a m2p' onclick='displayNote("+s+"); setNoteAsRead("+s+");' style='grid-template-columns: 1fr 110px 10px 15px'>")+"\t\t<img src='/assets/icons/"+_+"' class='left-icon mr1' width='28px' height='28px'>\t\t<div class='flex-container flex-col space-between ta-l'>")+"\t\t\t<span class='incert'>"+e[1].incert+"</span>\t\t\t<span class='small date'>"+d+" ago</span>",null===o&&1==note_category&&(h="\t\t<span class='smaller tred unsolved'>Unsolved</span>",m+=h),m=(m=(m=(m+="\t\t</div>")+"\t\t<span class='not_read_ball'></span>\t\t<button type='button' class='bs transparent flex-container' onclick='event.stopPropagation(); deleteNote("+s+","+l+")' style='padding:0'>")+" \t\t<img src='/assets/icons/times-solid.svg' width='12' height='12' class='filter-dred pointer' > \t</button>")+"\t</div\t></li>",t=parseHTML(m),y.appendChild(t),m="\t<div class='hidden note-result ta-l res-"+s+"'>",m=(m=(m+="\t\t<div class='flex-container space-between ml1 mr1' style=''>")+"\t\t\t<span class='ta-l smaller'><i>Created at "+p.toLocaleString()+" by "+a+"</i></span>\t\t</div>")+"\t\t\t<div class='ta-l note-style'>"+e[1].note+"</div>",h=null!==n?"Read at "+u.toLocaleString()+" by "+i:"unread",m=(m+="\t\t<div class='flex-container space-between ml1 mr1 mt2p' style=''>")+"\t\t\t<span class='ta-l read-time smaller'><i>"+h+"</i></span>\t\t</div>",1==note_category&&(h=null!==o?"Solved at "+c.toLocaleString()+" by <span class='solved-user'>"+r+"</span>":"unsolved",m=(m+="\t\t<div class='flex-container space-between ml1 mr1 mt2p' style=''>")+"\t\t\t<span class='ta-l solved-time smaller'><i>"+h+"</i></span>\t\t</div>"),m=m+"\t\t<div class='flex-container space-between ml1 mr1 mt2p' style=''>\t\t\t<button type='button' class='bs small' onClick='setNoteAsUnread("+s+")'>Mark Unread</button>",null===o&&1==note_category&&(h="\t\t<button type='button' class='bs small red' name='solved-button' onClick='setNoteAsSolved("+s+")'>Mark Solved</button>",m+=h),m=(m+="\t\t\t<button type='button' class='bs small red' onClick='deleteNote("+s+","+l+")'>Delete Note</button>")+"\t\t</div>\t</div>",t=parseHTML(m),v.appendChild(t))}),console.log("Dest Number for "+note_category+": "+b),n.innerText=b,0!=g?(o.nextElementSibling.classList.add("hidden"),o.classList.remove("hidden"),y.classList.remove("hidden")):(o.nextElementSibling.classList.remove("hidden"),o.classList.add("hidden"),y.classList.add("hidden")),showPopup(t),countUnreadNotes()}
