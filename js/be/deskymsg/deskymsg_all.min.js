function callBackMessages(e,s){"messages_get_new"==e&&callBackCheckNewMessages(e,s),"messages_get_sid"==e?callBackCheckSidMessages(e,s):"messages_send"==e?callBackSendMessage(s):"messages_state_update"==e?callBackStateUpdate(s):"messages_session_create"==e&&callBackMessageSessionCreate(s)}function callBackCheckSidMessages(e,s=[]){if(!sendingMessage){let a=!1,t=[];let l=messageSessionGet(),n;if(0!=s.length){if(s.hasOwnProperty("sup_state")&&messageUpdateSupState(s.sup_state),Array.from(Object.values(s)).reverse().forEach(function(e){Array.from(e).forEach(function(e){n=e[1];var s=e[4],e=e[3];n!=l&&console.log("Error in sid"),a=1!=e,1!=s&&2!=s||0!=e||(t.includes(n)||t.push(n),messagesSetRead=!1)})}),5<=logLevel&&console.log("[callBackCheckSidMessages] Call messagesAddAllElementByDatas"),messagesAddAllElementByDatas(s,l,!1),s.hasOwnProperty("sid_state")&&0==s.sid_state)return messagesDisableEnable("disableSimple"),void clearTimeout(intervalMessages);messagesDisableEnable("enable")}}}function callBackCheckNewMessages(e,s=[]){var a;0!=s.length&&(2<=logLevel&&console.log("[callBackCheckNewMessages] NEW MESSAGE"),5<=logLevel&&console.log(s),a=messageSessionGet(),s=Array.from(Object.keys(s))[0],5<=logLevel&&console.log("[callBackCheckNewMessages] sid:"+a+", tsid:"+s),5<=logLevel&&console.log("[callBackCheckNewMessages] messageMode:"+messageMode),messagesSetRead=!1,messageGetSidMessages(),messageMode||(s!=a&&(setCookie("messages_session",s,7),5<=logLevel&&console.log("[callBackCheckNewMessages] setting new sid: "+s)),messageShowNotify(1)))}function callBackSendMessage(e){console.log(e),messageUpdateId(e.oid,e.mid),sendingMessage=!1}function callBackStateUpdate(e){}function callBackMessageSessionCreate(e){5<=logLevel&&console.log("[callBackMessageSessionCreate] --\x3e Arr"),5<=logLevel&&console.log(e);e=e.sid;setCookie("messages_session",e,31),messagePanelGo()}var intervalMessages,allMessages,messageStatusInterval,messagesStates=["sending","sent","received","read","deleted","date-info","session-info"],sendingMessage=!1,messageMode=!1,messageNotified=!1,messagesSetRead=!0,intervalTime=14e3,intervalTimeMax=12e4,messagePanelReady=!1;function messagesTest(e){1<=logLevel&&console.log("[messagesTest] Init Message Panel"),900<level||messagePanelShow()}function messagePanelShow(){1<=logLevel&&console.log("[messagePanelShow] Show Message Panel");let s=document.querySelector("#help_messages_container");if(mobile){let e=document.querySelector("#popout_dark_back");e.contains(s)||(s.classList.add("mobile"),e.appendChild(s)),e.hidden=0}s.classList.remove("unvisible"),s.style.height=window.innerHeight-80+"px",messageMode||(messageMode=!0,messagesDisableEnable("disable"),messageSessionCreate())}function messagePanelGo(){let e=document.querySelector("#help_messages_container"),s=e.querySelector("textarea"),a=(setTimeout(function(){s.focus(),e.querySelector(".messages-container").lastElementChild.scrollIntoView({behavior:"smooth",block:"end"}),document.removeEventListener("keydown",msgSendWithKey),document.addEventListener("keydown",msgSendWithKey)},500),e.querySelector("ul.live-update"));0<Array.from(a.querySelectorAll("li.sent.other")).length&&messagesSetAllRead(),messageShowNotify(-1),intervalTime=5e3,messageSidMessagesIntervalCall()}function messagesSetAllRead(e=0){messagesSetRead||(messagesSidUpdateStateCall(3,0,e),messagesSetRead=!0)}function messageSidMessagesIntervalCall(){intervalTimeMax<(intervalTime+=5e3)&&(intervalTime=intervalTimeMax),messageMode&&(messageGetSidMessages(),4<=logLevel&&console.log("[messageSidMessagesIntervalCall] Next update call in "+intervalTime/1e3+" seconds"),intervalMessages=setTimeout(function(){messageSidMessagesIntervalCall()},intervalTime))}function messagePanelHide(){let e=document.querySelector("#help_messages_container");if(e.style.height="0px",e.classList.add("unvisible"),mobile){let e=document.querySelector("#popout_dark_back");setTimeout(function(){e.hidden=1},300)}messageMode=!1}function msgSendWithKey(e){13==e.keyCode&&messageMode&&messageSend(document.querySelector("#help_messages_container button.send-message"))}function messageShowNotify(e){let s=document.querySelector("#messages_container"),a=s.querySelector(".notif-icon"),t=s.querySelector("img"),l=parseInt(titleGetNum());0<(e=parseInt(e))?(a.innerText=e,t.classList.remove("filter-gray"),t.classList.add("filter-white"),a.classList.remove("hidden"),messageNotified||(2<(l=parseInt(l)+parseInt(e))&&(l=2),titleSetNum(l),messageNotified=!0)):e<=0&&(e<0&&(l=parseInt(l)+parseInt(e))<=0&&(l=0),0!=e&&0!=l||(l=0,a.classList.add("hidden"),t.classList.remove("filter-white"),t.classList.add("filter-gray")),messageNotified&&(titleSetNum(l),messageNotified=!1))}function messageHasSession(){var e=getCookie("messages_session");return void 0!==e&&!isNaN(e)&&0!=e.length}function messageSessionGet(){let e=getCookie("messages_session");return e=void 0!==e&&!isNaN(e)&&0!=e.length?e:0}function messageSessionCreate(){let e=new FormData;e.append("q","messages_session_create"),postFetch(e)}function messageGetSidMessages(s=0){if(!sendingMessage){var a=messageSessionGet();let e=new FormData;e.append("q","messages_get_sid"),e.append("admin",s),e.append("message_sess_id",a),5<=logLevel&&console.log("[messageGetSidMessages] FD call "+e.get("q")+" --\x3e sid: "+a),postFetch(e)}}function messageGetNewMessages(){let e=new FormData;e.append("q","messages_get_new"),5<=logLevel&&console.log("[messageGetNewMessages] FD call "+e.get("q")),postFetch(e)}function messageElementExists(e){let s=document.querySelector("#help_messages_container");return null!=s.querySelector("#mid_"+e)}function messageSend(s){let e=getParentByClass(s,"send-messages-container"),t=e.querySelector("textarea");s=unescape(escape(t.value).replace(/%0A/g,"<br>"));if(0!=s.length){intervalTime=1e4;var a=random(1,214748e3),l=messageSessionGet();messageAddElement(s,"sent",a,!0,Math.floor((new Date).getTime()/1e3)),messageAddDateInfo(),setTimeout(function(){let e=document.querySelector("#help_messages_container"),s=e.querySelector("textarea"),a=e.querySelector(".messages-container");t.disabled=0,t.value="",s.focus(),a.lastElementChild.scrollIntoView({behavior:"smooth",block:"end"})},500),document.querySelector("#help_messages_container li.other");t.focus(),sendingMessage=!0,t.disabled=1;let e=new FormData;e.append("q","messages_send"),e.append("message",s),e.append("sid",l),e.append("oid",a),3<=logLevel&&console.log("[messageSend] FD call "+e.get("q")),postFetch(e)}}function messagesAddAllElementByDatas(e,s,i){let a=document.querySelector("#help_messages_container"),t=a.querySelector("ul"),l=a.querySelector("textarea"),d=0;0!=e.length&&(null==e[s]?3<=logLevel&&console.log("datas null for sid "+s):(5<=logLevel&&console.log("[messagesAddAllElementByDatas] Arr"),5<=logLevel&&console.log(e),Array.from(Object.values(e[s])).reverse().forEach(function(e){var s=e[0],a=(e[1],e[2]),t=e[3],l=e[4],n=e[6];let o;e[5],o=0==t&&i?!0:1!=t||i?!1:!0;0==d&&(document.querySelector("#help_messages_container .chat-name").innerText="Support"),messageElementExists(s)||(messageAddElement(a,messagesStates[l],s,o,n),o||1!=l||messageUpdateStateCall(s,2)),messageUpdateState(s,messagesStates[l]),d++}),messageAddDateInfo(),e.hasOwnProperty("sid_state")&&0==e.sid_state&&(2<=logLevel&&console.log("[messagesAddAllElementByDatas] Close Session"),messageAddElement("Session Closed","session-info",-1,!1,0),clearTimeout(intervalMessages)),l.focus(),setTimeout(function(){t.scrollIntoView({behavior:"smooth",block:"end"})},100)))}function messageAddElement(e="",s,a,t,l){let n="",o="",i=(messagesStates.includes(s)&&(n+=s+" "),n+=t?"mine ":"other ",0<=a&&(o="id='mid_"+a+"' "),document.querySelector("#help_messages_container")),d=i.querySelector(".messages-container"),g=d.querySelector("ul.live-update");s="",s=(s+="<li "+o+" class='flex-container "+n+"' data-ts="+l+">")+"  <div class='flex-container flex-col'>    <div class='message'><span>"+e+"</span></div>  </div></li>",t=parseHTML(s);g.append(t)}function messageAddDateInfo(){let e=document.querySelector("#help_messages_container"),s=e.querySelector(".messages-container"),a=s.querySelector("ul.live-update"),t=(a.querySelectorAll(".date-info").forEach(function(e){e.remove()}),a.lastElementChild);var l=t.dataset.ts;let n=0,o=(t.classList.contains("mine")&&(n=1),new Date);o.setTime(1e3*l),messageAddElement(o.toLocaleString(),"date-info",-1,n,0)}function messageUpdateId(e,s){let a=document.querySelector("#help_messages_container"),t=a.querySelector("#mid_"+e);return null!=t&&(t.id="mid_"+s,!0)}function messagesSidUpdateStateCall(a,t=0,l=0){if(messageHasSession()&&0!=arguments.length){let e=new FormData,s=(e.append("q","messages_state_update"),messageSessionGet());0<t&&(s=t),e.append("message_sess_id",s),e.append("state",a),e.append("admin",l),5<=logLevel&&console.log("[messagesSidUpdateStateCall] Calling server:"+e.get("q")+", state: "+a+", sid: "+s+", admin:"+l),postFetch(e)}}function messageUpdateStateCall(s,a,t=0){if(messageHasSession()&&0!=arguments.length){intervalTime=5e3;let e=new FormData;e.append("q","messages_state_update"),e.append("message_id",s),e.append("state",a),e.append("admin",t),5<=logLevel&&console.log("[messageUpdateStateCall] calling server:"+e.get("q")+", state: "+a+", mid: "+s),postFetch(e)}}function messageUpdateState(e,s){let a=document.querySelector("#help_messages_container"),t=a.querySelector("#mid_"+e);return null!=t&&(!!messagesStates.includes(s)&&(t.classList.remove("sending","sent","received","read","deleted"),void t.classList.add(s)))}function messageUpdateSupState(e){let s=document.querySelector("#help_messages_container .online-status");s.classList.remove("online","offline","idle","unknow"),5<=logLevel&&console.log("[messageUpdateSupState] update support state to "+e),0==e?s.classList.add("unknow"):1==e?s.classList.add("idle"):2==e&&s.classList.add("online")}function checkBoundaries(e){e.style.maxHeight="90vh",e.style.maxWidth="none";var s=e.getBoundingClientRect().bottom,a=e.getBoundingClientRect().right,t=(e.getBoundingClientRect().left,e.getBoundingClientRect().top,window.innerHeight),l=window.innerWidth;console.log(s+" "+t),t<s&&(e.style.bottom="18px",e.style.top="auto"),l<a&&(e.style.right="0",e.style.left="auto")}function messagesDisableEnable(e){let s=document.querySelector("#help_messages_container"),a=s.querySelector(".messages-status"),t=s.querySelector(".messages-container"),l=s.querySelector("textarea"),n=s.querySelector("button.send-message");"disableSimple"==e?(messagePanelReady=!1,l.disabled=1,n.disabled=1):"disable"==e?(messagePanelReady=!1,t.classList.add("disabled"),l.disabled=1,n.disabled=1,a.classList.remove("hidden"),a.innerText="Connecting ...",clearInterval(messageStatusInterval),messageStatusInterval=setInterval(function(){a.innerText=a.innerText+"."},500)):"enable"==e&&(t.classList.remove("disabled"),l.disabled=0,n.disabled=0,a.classList.add("hidden"),a.innerText="",clearInterval(messageStatusInterval),messagePanelReady=!0)}
