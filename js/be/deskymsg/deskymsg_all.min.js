function callBackMessages(e,s){if("messages_get_new"==e&&callBackCheckNewMessages(e,s),"messages_get_sid"==e)callBackCheckSidMessages(e,s);else if("messages_send"==e)callBackSendMessage(s);else if("messages_state_update"==e)callBackStateUpdate(s);else{if("messages_session_create"!=e)return;callBackMessageSessionCreate(s)}}function callBackCheckSidMessages(e,s=[]){if(sendingMessage)return;let a=!1,t=!1,n=!1,l=[],i=messageSessionGet(),o;if(0!=s.length){if(s.hasOwnProperty("sup_state")&&messageUpdateSupState(s.sup_state),Array.from(Object.values(s)).reverse().forEach(function(e){Array.from(e).forEach(function(e){o=e[1];let s=e[4],d=e[3];o!=i&&console.log("Error in sid"),n=1!=d,(1==s||2==s)&&0==d&&(l.includes(o)||l.push(o),t=!0,messagesSetRead=!1),a=!0})}),logLevel>=5&&console.log("[callBackCheckSidMessages] Call messagesAddAllElementByDatas"),messagesAddAllElementByDatas(s,i,!1),s.hasOwnProperty("sid_state")&&0==s.sid_state){messagesDisableEnable("disableSimple"),clearTimeout(intervalMessages);return}messagesDisableEnable("enable")}}function callBackCheckNewMessages(e,s=[]){if(0==s.length)return;logLevel>=2&&console.log("[callBackCheckNewMessages] NEW MESSAGE"),logLevel>=5&&console.log(s);let a=messageSessionGet(),t=Array.from(Object.keys(s))[0];logLevel>=5&&console.log("[callBackCheckNewMessages] sid:"+a+", tsid:"+t),logLevel>=5&&console.log("[callBackCheckNewMessages] messageMode:"+messageMode),messagesSetRead=!1,messageGetSidMessages(),messageMode||(t!=a&&(setCookie("messages_session",t,7),logLevel>=5&&console.log("[callBackCheckNewMessages] setting new sid: "+t)),messageShowNotify(1))}function callBackSendMessage(e){console.log(e),messageUpdateId(e.oid,e.mid),sendingMessage=!1}function callBackStateUpdate(e){}function callBackMessageSessionCreate(e){logLevel>=5&&console.log("[callBackMessageSessionCreate] --> Arr"),logLevel>=5&&console.log(e);setCookie("messages_session",e.sid,31),messagePanelGo()}var intervalMessages,allMessages,messageStatusInterval,messagesStates=["sending","sent","received","read","deleted","date-info","session-info"],sendingMessage=!1,messageMode=!1,messageNotified=!1,messagesSetRead=!0,intervalTime=14e3,intervalTimeMax=12e4,messagePanelReady=!1;function messagesTest(e){logLevel>=1&&console.log("[messagesTest] Init Message Panel"),!(level>900)&&messagePanelShow()}function messagePanelShow(){logLevel>=1&&console.log("[messagePanelShow] Show Message Panel");let e=document.querySelector("#help_messages_container");if(mobile){let s=document.querySelector("#popout_dark_back");s.contains(e)||(e.classList.add("mobile"),s.appendChild(e)),s.hidden=0}e.classList.remove("unvisible"),e.style.height=window.innerHeight-80+"px",messageMode||(messageMode=!0,messagesDisableEnable("disable"),messageSessionCreate())}function messagePanelGo(){let e=document.querySelector("#help_messages_container"),s=e.querySelector("textarea");setTimeout(function(){s.focus(),e.querySelector(".messages-container").lastElementChild.scrollIntoView({behavior:"smooth",block:"end"}),document.removeEventListener("keydown",msgSendWithKey),document.addEventListener("keydown",msgSendWithKey)},500);Array.from(e.querySelector("ul.live-update").querySelectorAll("li.sent.other")).length>0&&messagesSetAllRead(),messageShowNotify(-1),intervalTime=5e3,messageSidMessagesIntervalCall()}function messagesSetAllRead(e=0){messagesSetRead||(messagesSidUpdateStateCall(3,0,e),messagesSetRead=!0)}function messageSidMessagesIntervalCall(){(intervalTime+=5e3)>intervalTimeMax&&(intervalTime=intervalTimeMax),messageMode&&(messageGetSidMessages(),logLevel>=4&&console.log("[messageSidMessagesIntervalCall] Next update call in "+intervalTime/1e3+" seconds"),intervalMessages=setTimeout(function(){messageSidMessagesIntervalCall()},intervalTime))}function messagePanelHide(){let e=document.querySelector("#help_messages_container");if(e.style.height="0px",e.classList.add("unvisible"),mobile){let s=document.querySelector("#popout_dark_back");setTimeout(function(){s.hidden=1},300)}messageMode=!1}function msgSendWithKey(e){13==e.keyCode&&messageMode&&messageSend(document.querySelector("#help_messages_container button.send-message"))}function messageShowNotify(e){let s=document.querySelector("#messages_container"),a=s.querySelector(".notif-icon"),t=s.querySelector("img"),n=parseInt(titleGetNum());(e=parseInt(e))>0?(a.innerText=e,t.classList.remove("filter-gray"),t.classList.add("filter-white"),a.classList.remove("hidden"),messageNotified||((n=parseInt(n)+parseInt(e))>2&&(n=2),titleSetNum(n),messageNotified=!0)):e<=0&&(e<0&&(n=parseInt(n)+parseInt(e))<=0&&(n=0),(0==e||0==n)&&(n=0,a.classList.add("hidden"),t.classList.remove("filter-white"),t.classList.add("filter-gray")),messageNotified&&(titleSetNum(n),messageNotified=!1))}function messageHasSession(){let e=getCookie("messages_session");return!(void 0===e||isNaN(e))&&0!=e.length}function messageSessionGet(){let e=getCookie("messages_session");return(void 0===e||isNaN(e)||0==e.length)&&(e=0),e}function messageSessionCreate(){let e=new FormData;e.append("q","messages_session_create"),postFetch(e)}function messageGetSidMessages(e=0){if(sendingMessage)return;let s=messageSessionGet(),a=new FormData;a.append("q","messages_get_sid"),a.append("admin",e),a.append("message_sess_id",s),logLevel>=5&&console.log("[messageGetSidMessages] FD call "+a.get("q")+" --> sid: "+s),postFetch(a)}function messageGetNewMessages(){let e=new FormData;e.append("q","messages_get_new"),logLevel>=5&&console.log("[messageGetNewMessages] FD call "+e.get("q")),postFetch(e)}function messageElementExists(e){return null!=document.querySelector("#help_messages_container").querySelector("#mid_"+e)}function messageSend(e){let s=getParentByClass(e,"send-messages-container").querySelector("textarea"),a=unescape(escape(s.value).replace(/%0A/g,"<br>"));if(0==a.length)return;intervalTime=1e4;let t=random(1,214748e3),n=messageSessionGet();messageAddElement(a,"sent",t,!0,Math.floor(new Date().getTime()/1e3)),messageAddDateInfo(),setTimeout(function(){let e=document.querySelector("#help_messages_container"),a=e.querySelector("textarea"),t=e.querySelector(".messages-container");s.disabled=0,s.value="",a.focus(),t.lastElementChild.scrollIntoView({behavior:"smooth",block:"end"})},500),document.querySelector("#help_messages_container li.other"),s.focus(),sendingMessage=!0,s.disabled=1;let l=new FormData;l.append("q","messages_send"),l.append("message",a),l.append("sid",n),l.append("oid",t),logLevel>=3&&console.log("[messageSend] FD call "+l.get("q")),postFetch(l)}function messagesAddAllElementByDatas(e,s,a){let t=document.querySelector("#help_messages_container"),n=t.querySelector("ul"),l=t.querySelector("textarea"),i=0;if(0!=e.length){if(null==e[s]){logLevel>=3&&console.log("datas null for sid "+s);return}logLevel>=5&&console.log("[messagesAddAllElementByDatas] Arr"),logLevel>=5&&console.log(e),Array.from(Object.values(e[s])).reverse().forEach(function(e){let s=e[0];e[1];let t=e[2],n=e[3],l=e[4],o=e[6],d,g;d=e[5],g=!1,1!=n||a||(g=!0),0==n&&a&&(g=!0);let r="";0==i&&(r="Support",document.querySelector("#help_messages_container .chat-name").innerText=r),messageElementExists(s)||(messageAddElement(t,messagesStates[l],s,g,o),g||1!=l||messageUpdateStateCall(s,2)),messageUpdateState(s,messagesStates[l]),i++}),messageAddDateInfo(),e.hasOwnProperty("sid_state")&&0==e.sid_state&&(logLevel>=2&&console.log("[messagesAddAllElementByDatas] Close Session"),messageAddElement("Session Closed","session-info",-1,!1,0),clearTimeout(intervalMessages)),l.focus(),setTimeout(function(){n.scrollIntoView({behavior:"smooth",block:"end"})},100)}}function messageAddElement(e="",s,a,t,n){let l="",i="";messagesStates.includes(s)&&(l+=s+" "),t?l+="mine ":l+="other ",a>=0&&(i="id='mid_"+a+"' ");let o=document.querySelector("#help_messages_container").querySelector(".messages-container").querySelector("ul.live-update"),d="";d+="<li "+i+" class='flex-container "+l+"' data-ts="+n+">",d+="  <div class='flex-container flex-col'>",d+="    <div class='message'><span>"+e+"</span></div>",d+="  </div>";let g=parseHTML(d+="</li>");o.append(g)}function messageAddDateInfo(){let e=document.querySelector("#help_messages_container").querySelector(".messages-container").querySelector("ul.live-update");e.querySelectorAll(".date-info").forEach(function(e){e.remove()});let s=e.lastElementChild,a=s.dataset.ts,t=0;s.classList.contains("mine")&&(t=1);let n=new Date;n.setTime(1e3*a),messageAddElement(n.toLocaleString(),"date-info",-1,t,0)}function messageUpdateId(e,s){let a=document.querySelector("#help_messages_container").querySelector("#mid_"+e);return null!=a&&(a.id="mid_"+s,!0)}function messagesSidUpdateStateCall(e,s=0,a=0){if(!messageHasSession()||0==arguments.length)return;let t=new FormData;t.append("q","messages_state_update");let n=messageSessionGet();s>0&&(n=s),t.append("message_sess_id",n),t.append("state",e),t.append("admin",a),logLevel>=5&&console.log("[messagesSidUpdateStateCall] Calling server:"+t.get("q")+", state: "+e+", sid: "+n+", admin:"+a),postFetch(t)}function messageUpdateStateCall(e,s,a=0){if(!messageHasSession()||0==arguments.length)return;intervalTime=5e3;let t=new FormData;t.append("q","messages_state_update"),t.append("message_id",e),t.append("state",s),t.append("admin",a),logLevel>=5&&console.log("[messageUpdateStateCall] calling server:"+t.get("q")+", state: "+s+", mid: "+e),postFetch(t)}function messageUpdateState(e,s){let a=document.querySelector("#help_messages_container").querySelector("#mid_"+e);if(null==a||!messagesStates.includes(s))return!1;a.classList.remove("sending","sent","received","read","deleted"),a.classList.add(s)}function messageUpdateSupState(e){let s=document.querySelector("#help_messages_container .online-status");s.classList.remove("online","offline","idle","unknow"),logLevel>=5&&console.log("[messageUpdateSupState] update support state to "+e),0==e?s.classList.add("unknow"):1==e?s.classList.add("idle"):2==e&&s.classList.add("online")}function checkBoundaries(e){e.style.maxHeight="90vh",e.style.maxWidth="none";let s=e.getBoundingClientRect().bottom,a=e.getBoundingClientRect().right;e.getBoundingClientRect().left,e.getBoundingClientRect().top;let t=window.innerHeight,n=window.innerWidth;console.log(s+" "+t),s>t&&(e.style.bottom="18px",e.style.top="auto"),a>n&&(e.style.right="0",e.style.left="auto")}function messagesDisableEnable(e){let s=document.querySelector("#help_messages_container"),a=s.querySelector(".messages-status"),t=s.querySelector(".messages-container"),n=s.querySelector("textarea"),l=s.querySelector("button.send-message");"disableSimple"==e?(messagePanelReady=!1,n.disabled=1,l.disabled=1):"disable"==e?(messagePanelReady=!1,t.classList.add("disabled"),n.disabled=1,l.disabled=1,a.classList.remove("hidden"),a.innerText="Connecting ...",clearInterval(messageStatusInterval),messageStatusInterval=setInterval(function(){a.innerText=a.innerText+"."},500)):"enable"==e&&(t.classList.remove("disabled"),n.disabled=0,l.disabled=0,a.classList.add("hidden"),a.innerText="",clearInterval(messageStatusInterval),messagePanelReady=!0)}