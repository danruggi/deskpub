function callBackCalendarLiveUpdate(e){let t=0;var n=getCookie("update_id");if((t=void 0!==n&&!isNaN(n)&&0<n.length?n:t)!=e.num&&(console.log("Updating Live... (pastId: "+t+", newId: "+e.num+")"),setCookie("update_id",e.num,.01),0!=t&&null!=e.num)){console.log("draw schema because updateId not zero");let e=new Date;if(e.getTime()-lastDrawSchema<=5e3)return void console.log("Draw Schema Protection Time");drawSchema()}callBackCalendarNotifShowAll(e.notif),console.log("new msgs: "+e.msgs),1==e.msgs&&messageGetNewMessages(),e.hasOwnProperty("cleaning")&&callBackCleaning(e.cleaning)}function callBackCalendarNotifShowAll(e){notifRemoveAllElements(),count_toread=0,Array.from(Object.values(e)).forEach(function(e){console.log(e);var t=e[4],n=e[5];let i=e[1];var o=e[0],a=e[6],l=e[7];let r=e[8];var c=e[9],e=e[10];let s="",d="";11==e&&(s="warning"),d=0<l?"read":(count_toread++,"toread"),null==i&&(i="System"),null==r&&(r=""),notifAddElement(t,n,i,r,s,d,o,e,a,c)}),notifSetNumber(count_toread),notifSetCursor()}function callBackCleaning(e){0!=map_settings.hotel.cleaning_mode&&(console.log(e),e.forEach(function(e){var t=e[0],n=e[1];let i=e[2],o=stringFromSeconds(e[5]),a=stringFromSeconds(e[4]),l=stringFromSeconds(e[3]),r=e[8];e=map_rooms_names[t][2];if(0==e)document.querySelectorAll("[id^='b_"+t+"_']").forEach(function(e){e.classList.add("clean-"+i),0==i&&(e.title="Waiting cleaning (~"+l+")"),1==i&&(e.title=r+" is cleaning this room (~"+a+")"),5==i&&(e.title="Room Ready - by "+r+" (~"+o+" ago)")});else if(1==e){let e=document.querySelector("#b_"+t+"_"+n);e.classList.add("clean-"+i),0==i&&(e.title="Waiting cleaning (~"+l+")"),1==i&&(e.title=r+" is cleaning this room (~"+a+")"),5==i&&(e.title="Room Ready - by "+r+" (~"+o+" ago)")}}))}function headerUpdate(){updateCheckinsCheckouts();let e=new FormData;var t;0<setNotifRead.length&&(t=setNotifRead.join("_"),e.append("notif_read",t),setNotifRead=[]),e.append("q","calendar_live_update_check"),postFetch(e)}function updateCheckinsCheckouts(){checkIns(),checkOuts()}function checkIns(){let e=new Intl.DateTimeFormat("en",{year:"2-digit",month:"2-digit",day:"2-digit"}),t=document.querySelector("header .checkin-number .check-numbers");if("object"==typeof t){var[{value:n},,{value:i},,{value:o}]=e.formatToParts(todayG),o=o+"_"+n+"_"+i;let d={};n=document.querySelectorAll("td[id^='"+o+"'")[1];if("object"==typeof n){let[l,r]=getxy(n),c=l,s=0;Array.from(document.querySelectorAll("td[id^='"+o+"'")).forEach(function(t){if(t.classList.contains("res")){var a=t.dataset.state;if(1==a||2==a||5==a){let n=!0,i=t.dataset.bid,o=t.dataset.cid;t=t.textContent;let e;e=5==a?"done":"todo",Array.from(document.querySelectorAll("td.res")).forEach(function(e){var t;[l,r]=getxy(e),l>=c||(t=e.dataset.bid,e=e.dataset.cid,t==i&&e==o&&(n=!1))}),n&&(d.hasOwnProperty(i)?d[i][0]=parseInt(d[i][0])+1:(d[i]=[1,o,t,e],"todo"==e&&s++))}}}),t.innerText=s,inOutHint(d,"checkin")}}}function inOutHint(e,o){let a="<ul class='checklist inout nodot p0 pl1 smaller'>",l="<ul class='checklist inout nodot p0 pl1 smaller'>";let t,r=("checkin"==o?(t=document.querySelector("header .checkin-number .hint"),a+="<li class='header valid azul'><h4 class='m0'>Will Arrive Today</h4></li>",l+="<li class='header valid'><h4 class='m0'>Arrived Today</h4></li>"):"checkout"==o&&(t=document.querySelector("header .checkout-number .hint"),a+="<li class='header '><h4 class='m0'>Will Leave Today</h4></li>",l+="<li class='header valid'><h4 class='m0'>Left Today</h4></li>"),"");0==Object.entries(e).length?t.classList.add("unvisible"):(t.classList.remove("unvisible"),Array.from(Object.entries(e)).forEach(function(e){var t=e[0],n=e[1][0],i=(e[1][1],e[1][2]);"todo"==e[1][3]?(r="error ","checkin"==o&&(r+="azul "),a=(a=(a+="<a href='/workspace/booking.php?bid="+t+"'> ")+"  <li class='grid-container grid-2col pl1 "+r+"'>    <span>"+i+"</span><span class='mr2'>"+n+" pax</span>")+"  </li></a>"):(r="valid",l=(l=(l+="<a href='/workspace/booking.php?bid="+t+"'> ")+"  <li class='grid-container grid-2col pl1 "+r+"'>    <span>"+i+"</span><span class='mr2'>"+n+" pax</span>")+"  </li></a>")}),a+="</ul>",l+="</ul>",e="<div class='grid-container grid-2col' style='align-items: flex-start;'>"+a+l,e+="</div>",t.innerHTML=e)}function checkOuts(){let e=new Intl.DateTimeFormat("en",{year:"2-digit",month:"2-digit",day:"2-digit"}),t=new Date,n=(t.setTime(todayG.getTime()-864e5),document.querySelector("header .checkout-number .check-numbers"));if("object"==typeof n){var[{value:i},,{value:o},,{value:a}]=e.formatToParts(t),a=document.querySelectorAll("td[id^='"+(a+"_"+i+"_"+o)+"'")[1];if("object"==typeof a){let[e,c]=getxy(a),s=e,d={},u=0;Array.from(document.querySelectorAll("td.res")).forEach(function(t){let a=!0;var l=t.dataset.state;if(5==l||9==l){let n=t.dataset.bid,i=t.dataset.cid;var r=t.textContent;let e,o=(5==l?e="todo":9==l&&(e="done"),t.dataset.xy.split("_")[0]);l=t.getAttribute("colspan");parseInt(o)+parseInt(l)-1==s&&(Array.from(document.querySelectorAll("td.res")).forEach(function(e){var t;[o,c]=getxy(e),o<=s||(t=e.dataset.bid,e=e.dataset.cid,t==n&&e==i&&(a=!1))}),a&&(d.hasOwnProperty(n)?d[n][0]=parseInt(d[n][0])+1:(d[n]=[1,i,r,e],"todo"==e&&u++)))}}),n.innerText=u,inOutHint(d,"checkout")}}}var currentPanelContainer,notificationNotified=!1;function notifShow(e){let t=document.querySelector("#live_update_icon"),n=e.querySelector(".right-panel");var i,o,a,l,r;0!=notifGetNumber()&&(t.classList.add("pointer"),currentPanelContainer=n.parentElement,n.parentElement.classList.add("active"),n.classList.remove("hidden"),n.style.maxHeight="none",n.style.maxWidth="none",e=n.getBoundingClientRect().bottom,i=n.getBoundingClientRect().right,o=n.getBoundingClientRect().left,a=n.getBoundingClientRect().top,l=window.innerHeight,r=window.innerWidth,l<e&&(n.style.maxHeight=l-a-35+"px"),r<i&&(n.style.maxWidth=r-o-27+"px"),document.addEventListener("mousemove",notifEvent))}var toClose=!1;function notifClose(){document.querySelectorAll(".right-panel-container").forEach(function(e){let t=e.querySelector(".right-panel");null===t||t.classList.contains("hidden")||(t.classList.add("hidden"),e.classList.remove("active"),setTimeout(function(){headerUpdate()},1e3))}),document.removeEventListener("mousemove",notifEvent)}function notifEvent(e){e.target.id;currentPanelContainer.contains(e.target)?toClose=!1:(toClose=!0,setTimeout(function(){toClose&&notifClose()},400))}function notifRemoveAllElements(){let e=document.querySelector("#live_update_icon"),t=e.querySelector("ul");for(;t.firstChild;)t.removeChild(t.firstChild)}function notifAddElement(e,t,n,i,o,a,l,r,c,s){iconurl="/assets/be/icons/",iconurl+="mail-toread"==o?"mail-toread.svg":"warning"==o?"alert-solid.svg":"toread"==a?"mail-toread.svg":"mail-ok.svg";o=stringFromSeconds(c);let d="",u="",m=("toread"==a&&(d="to-read"),2<i.length&&null!==i?u="onclick='headerUpdate(); window.location.replace(\""+i+"\")'":null!==s?u="onclick='"+s+";'":11==r&&(u='onclick=\'headerUpdate(); goSettings("b_settings_users", "b_settings_users_main_account")\''),document.querySelector("#live_update_icon")),f=m.querySelector("ul");c="",c=(c=(c=(c=(c+="<li id='"+l+"' class='grid-container grid-14col "+d+"' onmouseover='notifSetRead(this)' "+u+">")+"  <div class='img'><img src='"+iconurl+"' width='24' height='24'></div>  <div class='flex-container flex-col'>")+"    <div class='title'><h5 class='m0'>"+e+"</h5></div>    <div class='message'><span>"+t+"</span></div>")+"    <div class='grid-container grid-2col'>      <div class='user'><span>"+n+"</span></div>")+"      <div class='time'>"+o+" ago</div>    </div>  </div></li>",a=parseHTML(c);f.insertBefore(a,f.firstChild)}function notifTest(e){rand=random(1,200),notifShow(e,"size")}function notifSetRead(e){setNotifRead.includes(e.id)||e.classList.contains("to-read")&&(setNotifRead.push(e.id),e.classList.remove("to-read"),iconurl="/assets/be/icons/mail-ok.svg",e.querySelector("img").src=iconurl,e=notifGetShownNumber(),notifSetNumber(e-=1))}function notifGetNumber(){return Array.from(document.querySelectorAll("#live_update_icon .right-panel li")).length}function notifGetShownNumber(){return document.querySelector("#live_update_icon .notif-num span").innerText}function notifSetNumber(e){let t=document.querySelector("#live_update_icon"),n=t.querySelector(".notif-num");span=n.querySelector("span"),notificationNotified=0==e?(n.classList.add("hidden"),notificationNotified&&titleDecreaseNum(),!1):(n.classList.remove("hidden"),notificationNotified||titleIncreaseNum(),span.innerText=e,!0)}function notifSetCursor(){let e=document.querySelector("#live_update_icon");0<notifGetNumber()?e.classList.add("pointer"):e.classList.remove("pointer")}function notifLoad(){let e=new FormData;e.append("q","calendar_live_get_notifications"),postFetch(e)}
