function ckGuests(e){e.classList.toggle("selected"),1==e.querySelector(".checked").hidden?(e.querySelector(".checked").hidden=0,e.querySelector(".unchecked").hidden=1,e.querySelector("input").value="1"):(e.querySelector(".checked").hidden=1,e.querySelector(".unchecked").hidden=0,e.querySelector("input").value="")}function undoCk(e,t){formSubmitXML(e,"booking_ck_undo")}function deleteBooking(e){console.log(e),confirm("Are you sure you want to delete booking "+bid+"?")&&formSubmitXML(e,"booking_delete")}function deleteCustomer(e){formSubmitXML(e,"booking_customer_delete")}function buttonCostsClick(){document.querySelector("button[name='but_costs']").click()}function buttonPaymentsClick(){document.querySelector("button[name='but_payments']").click()}function showAllCosts(){setCookie("show_all_costs",1,.001),location.reload()}function xtraServiceSelect(e){let t=e.selectedIndex,n=e.options[t].attributes.alt.value,o=getParentByClass(e,"xtraForm").querySelector("input[name=amount]");0==o.value.length&&(o.value=n)}function returnableDepositSelect(e){let t=getParentByClass(e,"parentForm"),n=t.querySelector("select"),o=n.selectedIndex,l=0;n.options[o].hasAttribute("alt")&&(l=n.options[o].attributes.alt.value);let s=t.querySelector("input[name=amount]"),i=t.querySelector("input[name=num]").value,a=t.querySelector("input[name=total]");s.value=l,a.value=l*i}function depositReturn(e){let t=new FormData;t.append("bid",bid),t.append("did",e),t.append("q","booking_deposit_return"),postFetch(t)}function depositConvertToPayment(e,t){let n=new FormData;n.append("bid",bid),n.append("did",e),n.append("total",t),dep_name=document.getElementById("li_deposit_"+e).querySelector(".deposit-name").innerText,n.append("dep_name",dep_name),n.append("q","booking_deposit_to_payment"),postFetch(n)}function loadCustomersDetails(e){postHttpReq("booking_details_get",arr="&bid="+e)}function loadNotes(e){arr="&bid="+bid,note_category=e,postHttpReq("booking_note_get_all",arr)}function deleteNote(e,t){let n=new FormData;n.append("bid",t),n.append("nid",e),n.append("q","booking_note_delete"),postFetch(n)}function setNoteAsRead(e){let t=document.getElementById("note_"+e),n=document.getElementById("booking_notes_result").querySelector(".res-"+e+" span.read-time");1==note_category&&(n=document.getElementById("booking_alerts_result").querySelector(".res-"+e+" span.read-time"));let o=new FormData;o.append("bid",bid),o.append("nid",e),o.append("q","booking_note_set_read"),t.classList.contains("to-read")&&(t.classList.remove("to-read"),n.innerText="Read now",postFetch(o))}function setNoteAsUnread(e){let t=document.getElementById("note_"+e),n=document.getElementById("booking_notes_result").querySelector(".res-"+e+" span.read-time");1==note_category&&(n=document.getElementById("booking_alerts_result").querySelector(".res-"+e+" span.read-time"));let o=new FormData;o.append("bid",bid),o.append("nid",e),o.append("q","booking_note_set_unread"),t.classList.add("to-read"),n.innerText="Unread",postFetch(o)}function setNoteAsSolved(e){let t=document.getElementById("note_"+e),n=document.getElementById("booking_alerts_result");t.querySelector("span.cidname");let o=n.querySelector("span.solved-time");n.querySelector("span.solved-user");let l=n.querySelector("button[name='solved-button']"),s=t.querySelector("span.unsolved"),i=new FormData;i.append("bid",bid),i.append("nid",e),i.append("q","booking_note_set_solved"),t.classList.contains("to-solve")&&(t.classList.remove("to-solve"),o.innerText="Solved now",l.classList.remove("red"),l.classList.add("dgreen"),s.classList.add("hidden"),postFetch(i))}function displayNote(e){let t,n;0==note_category?(n=document.getElementById("booking_notes_list"),t=t=document.getElementById("booking_notes_result")):(n=document.getElementById("booking_alerts_list"),t=document.getElementById("booking_alerts_result")),n.querySelectorAll("li").forEach(function(e){e.classList.remove("selected")}),document.getElementById("note_"+e).classList.add("selected"),console.log("hide all note results and show "+e+" note in target "+t.id),t.querySelectorAll(".note-result").forEach(function(e){e.classList.add("hidden")}),t.querySelector(".res-"+e).classList.remove("hidden")}function countUnreadNotes(){let e,t,n;0==note_category?(e=document.getElementById("booking_notes_list"),n=document.getElementById("has_notes_to_read")):(e=document.getElementById("booking_alerts_list"),n=document.getElementById("has_alerts_to_read"),alerts_to_solve=Array.from(e.querySelectorAll("li.to-solve")).length),t=Array.from(e.querySelectorAll("li.to-read")).length,console.log(t),t>0?n.classList.remove("hidden"):n.classList.add("hidden")}function generateNewQrCodeFileUpload(e,t){if(0==arguments.length){let n=new FormData;n.append("bid",bid),n.append("q","booking_details_new_qr_link"),fetch("/servers/bookingDetails.php",{method:"POST",body:n}).then(e=>e.json()).then(t=>{if(console.log(t),t.hasOwnProperty("e"))error=!0,showMessage(!1,t.m,3);else{let n=t.hash;e="https://www.deskydoo.com/workspace/phoneUpload.php?h="+n+"&bid="+bid,console.log(e),generateNewQrCodeFileUpload(e,n)}});return}let o=document.getElementById("qrcode_file_upload"),l=o.querySelector(".qrcodeImage"),s=o.querySelector(".timer"),i=o.querySelector(".qrtitle");l.innerHTML="",s.innerHTML="",i.classList.remove("hidden"),qrcode=new QRCode(l,{text:e,width:128,height:128});let a=document.createElement("span"),r=document.createElement("span"),d=60;r.classList.add("small"),r.innerHTML="Link valid ",a.innerHTML="60 s",r.append(a),s.append(r),clearInterval(qrtimers.valid),qrtimers.valid=setInterval(function(){if(d--,a.innerHTML=d+" s",d<=0){l.innerHTML="",s.innerHTML="";let e=document.createElement("button");e.type="button",e.classList.add("bs","small","yellow"),e.innerHTML="Generate New QR Code",l.append(e),e.addEventListener("click",function(){generateNewQrCodeFileUpload()}),console.log("expired"),clearInterval(qrtimers.valid),clearInterval(qrtimers.connected)}},1e3);let c=0,p=new FormData;p.append("bid",bid),p.append("hash",t),p.append("q","booking_details_get_link_state"),clearInterval(qrtimers.connected),qrtimers.connected=setInterval(function(){fetch("/servers/bookingDetails.php",{method:"POST",body:p}).then(e=>e.json()).then(e=>{if(e.hasOwnProperty("state")){let t=e.state;if(1==t){if(t==c)return;c=t,clearInterval(qrtimers.valid),l.innerHTML="",s.innerHTML="",i.classList.add("hidden");let n=prepareStateContainer("/assets/be/icons/phone-cloud.svg","Phone connected","filter-green","160",!0);o.append(n)}else if(2==t){if(t==c)return;c=t;let a=o.querySelector(".state-container");a.parentNode.removeChild(a),a=prepareStateContainer("/assets/be/logo300_square_d.gif","Uploading File","none","120",!0),o.append(a)}else if(9==t){if(t==c)return;c=t;let r=o.querySelector(".state-container");r.parentNode.removeChild(r),r=prepareStateContainer("/assets/be/icons/check-solid.svg","File Uploaded","filter-green","100",!1),o.append(r),clearInterval(qrtimers.connected),clearInterval(qrtimers.valid),setTimeout(function(){setPopupDetailsBookingImage(),r.parentNode.removeChild(r)},2e3)}else if(-1==t){c=t,console.log(t),showMessage(!1,"Error uploading file");let d=o.querySelector(".state-container");d.parentNode.removeChild(d),d=prepareStateContainer("/assets/be/icons/times-solid.svg","Error Uploading","filter-dred","100",!0),o.append(d),clearInterval(qrtimers.connected),clearInterval(qrtimers.valid)}else t=0}})},2e3),console.log(">>>"+e)}function prepareStateContainer(e,t,n,o,l){let s=document.createElement("div"),i=document.createElement("img"),a=document.createElement("h3"),r=document.createElement("button");return s.classList.add("state-container","flex-container","flex-col"),i.width=o,i.height=o,i.classList.add(n,"m0a"),a.classList.add("tgreen","m0"),r.classList.add("bs","transparent","small","tcoral"),r.type="button",r.innerHTML="Cancel",s.append(i),s.append(a),l&&s.append(r),i.src=e,a.innerHTML=t,r.addEventListener("click",function(e){clearInterval(qrtimers.connected),s.parentNode.removeChild(s),generateNewQrCodeFileUpload(),e.stopPropagation()}),s}function setPopupDetailsBookingImage(){let e=new FormData;e.append("bid",bid),e.append("q","booking_details_get_file_name"),fetch("/servers/bookingDetails.php",{method:"POST",body:e}).then(e=>e.json()).then(e=>{if(e.hasOwnProperty("name")){let t=e.name;booking_file_name=t,uploadImageControl("showPreview",t),console.log(t)}else generateNewQrCodeFileUpload()})}function showBottomSection(e){let t="bottom_"+e.attributes.name.value.replace("but_",""),n=document.getElementById(t),o="&bid="+bid;if("bottom_costs"==t)postHttpReq("booking_bottom_costs",o);else if("bottom_history"==t){let l=new FormData;l.append("bid",bid),l.append("q","booking_bottom_history"),postFetch(l)}document.querySelectorAll(".bottom-section").forEach(function(e){e.classList.add("hidden")}),n.classList.toggle("hidden"),e.scrollIntoView({behavior:"smooth"}),console.log(t)}function showBookingImagePopup(){document.getElementById("popup_booking_assoc_image").style.backgroundImage="url("+booking_file_name+")",closePopup(),console.log("ok showing"),showPopup("popout_images")}function deleteBookingImage(){let e=new FormData;e.append("bid",bid),e.append("q","booking_details_delete_file_name"),postFetch(e)}function printInvoice(){document.createElement("div").classList.add("to-print");let e=parseHTML(document.getElementById("book_top"));document.body.appendChild(e)}function verifyCheckout(e){let t=e.form,n,o,l={},s=!0,i=document.getElementById("popout_checkout_verify"),a,r=0,d="",c;for(a=i.querySelector(".hidden-customers-out"),t.querySelectorAll("input").forEach(function(e){console.log(e.name+"-->"+e.value),"bid"==e.name?n=e.value:"state"==e.name?o=e.value:isNaN(e.name)?e.name.startsWith("rb_")&&(d+="<input type='hidden' name='"+e.name+"' value='"+e.value+"'>"):(0==e.value&&(s=!1),l[e.name]=e.value,d+="<input type='hidden' name='"+e.name+"' value='"+e.value+"'>")});a.firstChild;)a.removeChild(a.firstChild);c=parseHTML(d),a.appendChild(c),i.querySelectorAll(".ckout-verify").forEach(function(e){e.querySelector("img.ckout-forced").classList.add("hidden"),e.querySelector("button").classList.remove("hidden")}),i.querySelector("button.toggle_ckout").disabled=1;let p=document.querySelector(".right .live-balance").innerText;(a=i.querySelector(".has-balance")).classList.add("hidden"),s&&p>0&&(a.classList.remove("hidden"),r++);let u=document.querySelector(".right .live-deposits").innerText;(a=i.querySelector(".has-deposits")).classList.add("hidden"),s&&u>0&&(a.classList.remove("hidden"),r++),(a=i.querySelector(".has-nights-out")).classList.add("hidden"),d="<span class='small w100'>";let m=!1,h;if(h=a.querySelector(".message-section"),document.querySelectorAll("#bottom_guests .total-nights-out").forEach(function(e){let t=e.innerText,n=e.dataset.cid,o=e.dataset.cname;1==l[n]&&(d+="Customer <b>"+o+"</b> spent <span class='big bold tred'>"+t+" </span> nights out<br>",m=!0)}),d+="Confirm that?</span>",m){for(;h.firstChild;)h.removeChild(h.firstChild);c=parseHTML(d),h.appendChild(c),a.classList.remove("hidden"),r++}if((a=i.querySelector(".has-unsolved-alerts")).classList.add("hidden"),alerts_to_solve>0&&s&&(a.querySelector(".alerts-to-solve-num").innerText=alerts_to_solve,a.classList.remove("hidden"),r++),0==r){let g=i.querySelector("button.toggle_ckout");g.disabled=0,formSubmitXML(g,"booking_ckout");return}console.log("checkout verify"),closePopup(),showPopup("popout_checkout_verify")}function confirmForceCheckout(e){let t=e.form,n=e.parentElement.querySelector("input"),o=e.parentElement.querySelector("img");n.value=1,o.classList.remove("hidden"),e.classList.add("hidden");let l=Array.from(t.querySelectorAll("div.ckout-verify:not(.hidden)")).length,s=Array.from(t.querySelectorAll("img.ckout-forced:not(.hidden)")).length;console.log(l+"-->"+s),s==l&&(t.querySelector("button.toggle_ckout").disabled=0)}function showCustomerDetails(e){let t="",n,o=document.getElementById("popout_details"),l=1;null!==e.details&&(l=e.details[1]),console.log(e),Object.entries(e).forEach(function(e){if(console.log(e),isNaN(e[0])){if("channels"==e[0]){let s="",i=o.querySelector("select[name='bookingChannel']");Object.entries(e[1]).forEach(function(e,n){t="",e[1][0]==l&&(t=" selected"),s+="<option value='"+e[1][0]+"'"+t+">"+e[1][1]+"</option>"});let a=parseHTML(s);i.appendChild(a)}}else n=e[0],Object.entries(dets=mapDetails(e)).forEach(function([e,t]){let l=o.querySelector("[name='"+n+"_"+e+"']");null!=l&&(l.value=t)})}),setPopupDetailsBookingImage(),showPopup("popout_details")}function mapDetails(e){return{cat:e[1][1],type:e[1][2],title:e[1][3],email:e[1][5],idtype:e[1][6],idnum:e[1][7],phonenum:e[1][8],street:e[1][9],city:e[1][10],cp:e[1][11],state:e[1][12],country:e[1][13]}}function showBottomExtrasAndDiscounts(e){let t=document.getElementById("bottom_costs").querySelector(".right"),n="<h2>Discounts and Extras</h2>";Array.from(Object.entries(e)).reverse().forEach(function(e){let o=e[1].discounts,l=e[1].extras;if(console.log(l),n+="<ul class='boxlist gray ta-l'>",n+="<li class='header'><h2 class='m0'>"+e[0]+"</h2></li>",null!=o&&Object.entries(o).forEach(function(e){0==e[0]&&(n+="<li class='header'><h5 class='m0 ml1'>Discounts</h5></li>"),n+="<li class=''>",n+="<form>",n+="<input type='hidden' name='bid' value='"+e[1].bid+"'>",n+="<input type='hidden' name='id' value='"+e[1].id+"'>",n+="	<button type='button' class='bs transparent flex-container' onclick='formSubmitXML(this, `booking_bottom_delete_discount`)' style='position: absolute; top:50%; right: 0; transform: translate(0, -50%);'>",n+=" 	<img src='/assets/be/icons/times-solid.svg' width='12' height='12' class='filter-dred pointer' >",n+=" </button>",n+="</form>",n+="	<div class='flex-container space-between mr2'>",n+="		<span>"+e[1].insert_date+"</span>",n+="		<span class='tred'><b>-"+e[1].amount+"</b> <span class='small'>"+curr+"</span></span>",n+="	</div>",e[1].note.length>0&&(n+="<div class='ml1 mr1'><i>"+e[1].note+"</i></div>"),n+="</li>"}),null!=l){let s="---";Object.entries(l).forEach(function(e){0==e[0]&&(n+="<li class='header'><h5 class='m0 ml1'>Extras</h5></li>"),null!==e[1].name&&(s=e[1].name);let t=e[1].price*e[1].num;n+="<li class=''>",n+="<form>",n+="<input type='hidden' name='bid' value='"+e[1].bid+"'>",n+="<input type='hidden' name='id' value='"+e[1].id+"'>",n+="	<button type='button' class='bs transparent flex-container' onclick='formSubmitXML(this, `booking_bottom_delete_service`)' style='position: absolute; top:50%; right: 0; transform: translate(0, -50%);'>",n+=" 	<img src='/assets/be/icons/times-solid.svg' width='12' height='12' class='filter-dred pointer'>",n+=" </button>",n+="</form>",n+="	<div class='flex-container space-between mr2'>",n+="		<span>"+e[1].insert_date+"</span>",n+="		<span class='tgreen'><b>+"+t+"</b> <span class='small'>"+curr+"</span></span>",n+="	</div>",n+="	<div class='flex-container space-between mr2'>",n+="		<span><i>"+s+"</i></span>",n+="		<span><i>pax: "+e[1].num+"</i></span>",n+="	</div>",n+="</li>"})}let i=parseHTML(n+="</ul>");for(console.log(i);t.firstChild;)t.removeChild(t.firstChild);t.appendChild(i)})}function showBottomHistory(e){let t=document.getElementById("bottom_history").querySelector("ul.history-ul"),n="";n+="<li class='header grid-container grid-4col'><h4>Time</h4><h4>Action</h4><h4>Details</h4><h4>By User</h4></li>",Object.entries(e).forEach(function(e){n+="<li class='grid-container grid-4col'>",n+="	<span>"+e[1].insert_date+"</span>",n+="	<span>"+user_actions[e[1].code]+"</span>",n+="	<span>"+e[1].details+"</span>",n+="	<span>"+e[1].name+"</span>",n+="</li>"});let o=parseHTML(n);for(console.log(o);t.firstChild;)t.removeChild(t.firstChild);t.classList.remove("hidden"),t.appendChild(o)}function showNotes(e){let t=0,n=0,o="popout_notes",l=document.getElementById("booking_notes_list"),s=document.getElementById("booking_notes_result"),i=document.getElementById("notes_numbers"),a="note1-solid.svg",r="";1==note_category&&(o="popout_alerts",l=document.getElementById("booking_alerts_list"),s=document.getElementById("booking_alerts_result"),i=document.getElementById("alerts_numbers"),a="alert-solid.svg",r="filter-red");let d=s.parentElement;for(document.querySelectorAll("textarea[name='note']").forEach(function(e){e.value=""});l.firstChild;)l.removeChild(l.firstChild);for(;s.firstChild;)s.removeChild(s.firstChild);console.log(e),Array.from(Object.entries(e)).reverse().forEach(function(e){let o=e[1].cat,i=e[1].read_date,r=e[1].solved_date,d=e[1].nid;e[1].cid;let c=e[1].bid,p=e[1].created_user,u=e[1].read_user,m=e[1].solved_user,h=e[1].insert_date,g=new Date(e[1].solved_date),b=new Date(e[1].read_date),f=new Date(h),y=parseInt((new Date-f)/1e3),v=stringFromSeconds(y),_=xclass="",k="";if(null===i&&(xclass="to-read"),null===r&&1==note_category&&(xclass+=" to-solve"),o!=note_category)return;n++,t++,_+="<li id='note_"+d+"' class='top noarrow highlighted "+xclass+" cat"+o+"'>",_+="	<div class='grid-container no-gap pointer m0a m2p' onclick='displayNote("+d+"); setNoteAsRead("+d+");' style='grid-template-columns: 1fr 110px 10px 15px'>",_+="		<img src='/assets/be/icons/"+a+"' class='left-icon mr1' width='28px' height='28px'>",_+="		<div class='flex-container flex-col space-between ta-l'>",_+="			<span class='incert'>"+e[1].incert+"</span>",_+="			<span class='small date'>"+v+" ago</span>",null===r&&1==note_category&&(_+=k="		<span class='smaller tred unsolved'>Unsolved</span>"),_+="		</div>",_+="		<span class='not_read_ball'></span>",_+="		<button type='button' class='bs transparent flex-container' onclick='event.stopPropagation(); deleteNote("+d+","+c+")' style='padding:0'>",_+=" 		<img src='/assets/be/icons/times-solid.svg' width='12' height='12' class='filter-dred pointer' >",_+=" 	</button>",_+="	</div	>";let S=parseHTML(_+="</li>");l.appendChild(S),_="	<div class='hidden note-result ta-l res-"+d+"'>",_+="		<div class='flex-container space-between ml1 mr1' style=''>",_+="			<span class='ta-l smaller'><i>Created at "+f.toLocaleString()+" by "+p+"</i></span>",_+="		</div>",_+="			<div class='ta-l note-style'>"+e[1].note+"</div>",k=null!==i?"Read at "+b.toLocaleString()+" by "+u:"unread",_+="		<div class='flex-container space-between ml1 mr1 mt2p' style=''>",_+="			<span class='ta-l read-time smaller'><i>"+k+"</i></span>",_+="		</div>",1==note_category&&(k=null!==r?"Solved at "+g.toLocaleString()+" by <span class='solved-user'>"+m+"</span>":"unsolved",_+="		<div class='flex-container space-between ml1 mr1 mt2p' style=''>",_+="			<span class='ta-l solved-time smaller'><i>"+k+"</i></span>",_+="		</div>"),_+="		<div class='flex-container space-between ml1 mr1 mt2p' style=''>",_+="			<button type='button' class='bs small' onClick='setNoteAsUnread("+d+")'>Mark Unread</button>",null===r&&1==note_category&&(_+=k="		<button type='button' class='bs small red' name='solved-button' onClick='setNoteAsSolved("+d+")'>Mark Solved</button>"),_+="			<button type='button' class='bs small red' onClick='deleteNote("+d+","+c+")'>Delete Note</button>",_+="		</div>",_+="	</div>",S=parseHTML(_),s.appendChild(S)}),console.log("Dest Number for "+note_category+": "+n),i.innerText=n,0!=t?(d.nextElementSibling.classList.add("hidden"),d.classList.remove("hidden"),l.classList.remove("hidden")):(d.nextElementSibling.classList.remove("hidden"),d.classList.add("hidden"),l.classList.add("hidden")),showPopup(o),countUnreadNotes()}