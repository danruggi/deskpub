function drawSchema(){let e=new Date;lastDrawSchema=e.getTime(),"undefined"==typeof(schema=getCookie("schema_"+hid))||schema.length<=3||"undefined"==schema||!Boolean(useSchemaCookie)?(console.log("getting schema from DB"),postHttpReq("calendar_schema_get")):(console.log("loaded schema from cookies"),callBackDrawSchema(JSON.parse(schema)))}function retrieveBookings(){var e=[view_sd,view_ed];postHttpReq("calendar_retrieve_bookings",e)}function makeCellABooking(e,t,o,a,l){e.innerText=t,e.classList.contains("n")&&(e.classList.remove("n"),e.classList.add("res")),0<a&&(e.dataset.bid=a,e.dataset.tid=o,e.dataset.cid=l)}function resizeABooking(t,e,o,a,l,n){var i=t.textContent;let s=spanlist="";var[d,r]=getxy(t),c=Math.min(e,o),u=Math.max(e,o);let m=i;e=t.dataset.state;for(let e=0;e<o;e++)s+="1fr ",spanlist+="<span id='"+t.id+"_"+e+"' class='dragger'></span>";for(m+="<div id='"+t.id+"_grid' class='in-grid' style='grid-template-columns: "+s+"'>"+spanlist+"</div>",Boolean(l)||9==e?(t.classList.add("locked"),m+="<span id='"+t.id+"_inf' class='right infinite'></span>"):m+="<span id='"+t.id+"_res' class='right resizer'></span>",(n=0==map_settings.user.cal_show_balance?!1:n)&&100!=e&&(m+="<span class='balance-high'></span>",t.classList.add("hasBalance"));t.firstChild;)t.removeChild(t.firstChild);i=parseHTML(m);t.appendChild(i),t.setAttribute("colspan",o);for(let t=c;t<u;t++){var g=d+t;let e=table.querySelector("td.cell[data-xy='"+g+"_"+r+"']");if(null==e||null==typeof e)return void drawSchema();if(!e.classList.contains("n"))return!1;(Boolean(a)?showThisCell:hideThisCell)(e.id)}}function setBookingState(e,t){0!=t&&(1==t?e.classList.add("s_unconfirmed"):2==t?e.classList.add("s_confirmed"):5==t?e.classList.add("s_checkedin"):9==t?e.classList.add("s_checkedout"):100==t&&e.classList.add("s_blocked")),e.dataset.state=t}function setMetaLeftDate(e,t){e.dataset.leftDate=t}function addGuestToReservation(e){rightMenuClose();e=e.dataset.bid;isNaN(e)||(addGuestModeShow(e,document.querySelector("td[data-bid='"+e+"']").textContent),highlightReservationShow(e),document.addEventListener("keyup",keyUpAddGuestMode))}function addNightToReservation(e){rightMenuClose();var t=e.dataset.bid,e=e.dataset.cid;isNaN(t)||(addNightModeShow(e,document.querySelector("td[data-bid='"+t+"']").textContent),highlightCustomerShow(e),document.addEventListener("keyup",keyUpAddNightMode))}function highlightReservation(e){rightMenuClose(),highlightReservationShow(e.dataset.bid),setTimeout(function(){highlightHide()},1e3)}function highlightReservationShow(e){highlighted=!0,document.querySelectorAll("td[data-bid='"+e+"']").forEach(function(e){e.classList.add("highlighted")})}function highlightCustomer(e){rightMenuClose(),highlightCustomerShow(e.dataset.cid),setTimeout(function(){highlightHide()},1e3)}function highlightCustomerShow(e){highlighted=!0,document.querySelectorAll("td[data-cid='"+e+"']").forEach(function(e){e.classList.add("highlighted")})}function highlightHide(){highlighted=!1,document.querySelectorAll("td.highlighted").forEach(function(e){e.classList.remove("highlighted")})}function addGuestModeShow(e,t){add_guest_mode=!0,document.getElementById("add-guest-mode").classList.remove("hidden"),document.getElementById("add-guest-mode").querySelector(".book-id").innerText=hid+"-"+e+" ("+t+")",document.querySelectorAll("td.n").forEach(function(e){e.classList.remove("n"),e.classList.add("n-add")})}function addGuestModeHide(){add_guest_mode=!1,document.getElementById("add-guest-mode").classList.add("hidden"),document.removeEventListener("keyup",keyUpAddGuestMode),document.querySelectorAll("td.n-add").forEach(function(e){e.classList.remove("n-add"),e.classList.add("n")})}function addNightModeShow(e,t){add_night_mode=!0,document.getElementById("add-night-mode").classList.remove("hidden"),document.getElementById("add-night-mode").querySelector(".book-id").innerText=hid+"-"+e+" ("+t+")",document.querySelectorAll("td.n").forEach(function(e){e.classList.remove("n"),e.classList.add("n-add")})}function addNightModeHide(){add_night_mode=!1,document.getElementById("add-night-mode").classList.add("hidden"),document.removeEventListener("keyup",keyUpAddGuestMode),document.querySelectorAll("td.n-add").forEach(function(e){e.classList.remove("n-add"),e.classList.add("n")})}function maxCellColspan(e){var t,o,a=document.getElementById(e);[t,o]=getxy(a);for(var l=1;l<35&&"object"==typeof(a=table.querySelector("td.cell[data-xy='"+(t+l)+"_"+o+"']"))&&null!==a&&a.classList.contains("n");l++);return l}function makeBookingACell(t){var e=t.attributes.colspan.value;for(1<e&&resizeABooking(t,e,1,!0,!1);t.firstChild;)t.removeChild(t.firstChild);t.setAttribute("colspan",""),t.setAttribute("meta",""),t.removeAttribute("colspan"),delete t.dataset.bid,delete t.dataset.tid,delete t.dataset.cid,delete t.dataset.state,t.classList.remove("res"),t.classList.forEach(function(e){e.startsWith("s_")&&t.classList.remove(e)}),t.classList.add("n")}function hideThisCell(e){document.getElementById(e).classList.add("hidden"),document.getElementById(e).classList.add("res_over")}function showThisCell(e){document.getElementById(e).classList.remove("hidden"),document.getElementById(e).classList.remove("res_over")}function createMovingDiv(e,t,o,a,l){for(var e=e.target.getBoundingClientRect(),n=e.top,e=e.left,a=(a.textContent,getComputedStyle(a).backgroundColor.replace("rgb","rgba").replace(")",", .5)")),i=l;i<ocol;i++)i<=l+1&&0;var s=document.getElementById("moving_div");s.hidden=0,s.style.display="flex",s.style.top=n+"px",s.style.left=e+"px",s.style.width=t+"px",s.style.height=o+"px",s.style.backgroundColor=a,s.addEventListener("mousemove",mouseMoveDragging)}function unselectAll(){Array.from(document.querySelectorAll(".highlight")).forEach(function(e){e.classList.remove("highlight")})}function validatingSelection(e){Boolean(e)?Array.from(document.querySelectorAll(".highlight")).forEach(function(e){e.classList.remove("invalid")}):Array.from(document.querySelectorAll(".highlight")).forEach(function(e){e.classList.add("invalid")})}function bookingOverlay(e,t){Boolean(t)?(console.log("adding overlay"),document.getElementById(e).classList.add("overlay")):(console.log("removing overlay"),document.getElementById(e).classList.remove("overlay"))}function getxy(e){var t;y=c=0;if("object"!=typeof e)return[0,0];if("SPAN"!==e.nodeName&&"TD"!==e.nodeName)return[0,0];for(;!e.hasAttribute("data-xy");)if(e=e.parentElement,3<=++c)return[0,0];return t=e.dataset.xy.split("_"),[parseInt(t[0]),y=parseInt(t[1])]}function goToday(){new Intl.DateTimeFormat("en",{year:"numeric",month:"2-digit",day:"2-digit"});centerDate.setTime(todayG.getTime()),setCookie("centerDate",centerDate.getTime(),.002),document.querySelector("#calendar_date_selector").value=centerDate.getFullYear()+"-"+String(parseInt(centerDate.getMonth())+1).padStart(2,"0")+"-"+String(parseInt(centerDate.getDate())).padStart(2,"0"),drawSchema()}function slideCal(e){e*=864e5;centerDate.setTime(centerDate.getTime()+e),setCookie("centerDate",centerDate.getTime(),.002),document.querySelector("#calendar_date_selector").value=centerDate.getFullYear()+"-"+String(parseInt(centerDate.getMonth())+1).padStart(2,"0")+"-"+String(parseInt(centerDate.getDate())).padStart(2,"0"),drawSchema()}function newBookClick(e,t){let o=e.form,a=o.querySelector("input[name='sel']"),l=o.querySelector("input[name='sel_cid']");return a.value=selected,l.value=selected_cid,formSubmitXML(e,"calendar_booking_new",t),!1}function calendarRoomLock(e){let t=e.form;t.querySelector("input[name='sel']");e="&sel="+selected;return postHttpReq("calendar_room_lock",e),closePopup(),!1}function customerSearch(e,t){t=t.value;let o=document.getElementById("booking_add_form_results");if(t.length<3||27==e.keyCode)o.classList.add("hidden");else{let e=new FormData;e.append("val",t),e.append("q","calendar_customer_search"),postFetch(e)}}function prepareBookPopup(){let o=0,a=0,l=0,n=[],e=new Date,t=new Date,i=new Intl.DateTimeFormat("en",{year:"numeric",month:"short",day:"2-digit"});selected.forEach(function(e){var e=e.split("_"),t=Date.parse("20"+e[0]+"-"+e[1]+"-"+e[2]);0==o&&(o=t),0==a&&(a=t),t<=o&&(o=t),t>=a&&(a=t),n.includes(e[4])||n.push(e[4]),l=e[3]}),o+=864e5,a+=1728e5;var s=parseInt((a-o)/864e5),[{value:d},,{value:r},,{}]=(e.setTime(o),t.setTime(a),i.formatToParts(e)),[{value:c},,{value:u},,{}]=i.formatToParts(t);let m=document.getElementById("popup_calendar_1"),g=m.querySelector(".book-start-date"),h=m.querySelector(".book-end-date");g.querySelector(".day").innerText=r,g.querySelector(".month").innerText=d,g.querySelector(".dow").innerText=dow_long[e.getDay()],h.querySelector(".day").innerText=u,h.querySelector(".month").innerText=c,h.querySelector(".dow").innerText=dow_long[t.getDay()];r=map_rooms_names[l][0],d=map_rooms_names[l][1],u=roomsCatImg(d);m.querySelector(".room-name").innerText=r,m.querySelector(".tot-nights").innerText=s,m.querySelector(".tot-guests").innerText=n.length,m.querySelector(".img-room-cat").attributes.src.value="/assets/be/icons/"+u}function getBookingBalanceFromCache(){if(0!=map_settings.user.cal_show_balance){let t="",e=(Array.from(document.querySelectorAll("td.res")).forEach(function(e){t+=e.dataset.bid+"_"}),new FormData);e.append("bidsString",t),e.append("q","calendar_cache_balance_get_all"),postFetch(e)}}function cacheRemoveAllBalancesFromCalendar(){document.querySelectorAll("td.hasBalance").forEach(function(e){e.classList.remove("hasBalance");let t=e.querySelector(".balance-high");null!==t&&t.parentNode.removeChild(t)})}function bitsoCalDayClick(e){setCookie("centerDate",e.getTime(),.0035),drawSchema()}function calculateAndShowOccupancy(){if(0!=map_settings.user.cal_show_occupy){let o=document.getElementById("maincalendar");str="";var t=getCookie("timeframe");if(void 0!==t&&!isNaN(t)&&0!=t.length){Array.from(o.querySelectorAll(".occupancy")).forEach(function(e){e.remove()});for(let e=0;e<t;e++){a=o.getElementsByClassName("cell")[e].id.split("_"),str=a[0]+"_"+a[1]+"_"+a[2];let t=full=tot=0;Array.from(o.querySelectorAll("td[id^='"+str+"']")).forEach(function(e){tot++,e.classList.contains("res")||e.classList.contains("res_over")?full++:t++});var a="<span class='occupancy small'><b>"+parseInt(100*full/tot)+"</b> <span class='smaller'>%</span></span>";a=parseHTML(a),document.getElementsByTagName("th")[e+2].firstElementChild.appendChild(a)}}}}function rightMenuClose(){document.querySelectorAll(".right-click-menu").forEach(function(e){e.classList.add("hidden")}),document.removeEventListener("mousemove",closeContextMenu)}function callBackDrawSchema(e){let i,t,s;let o=new Intl.DateTimeFormat("en",{year:"numeric",month:"short",day:"2-digit"}),d=new Intl.DateTimeFormat("en",{year:"2-digit",month:"2-digit",day:"2-digit"}),a=new Intl.DateTimeFormat("en",{year:"numeric",month:"2-digit",day:"2-digit"});t=JSON.stringify(e),Boolean(useSchemaCookie)&&setCookie("schema_"+hid,t,31),void 0!==(s=getCookie("timeframe"))&&!isNaN(s)&&0!=s.length||(s=7,setCookie("timeframe",s,31)),mobile&&(s=3);var l=getCookie("centerDate");void 0!==l&&!isNaN(l)&&0<l.length&&(centerDate.setTime(l),console.log("cookieCenterDate found: "+l)),console.time("DrawSchema"),console.log("centerdate: "+centerDate);let r=centerDate.getTime(),c=new Date;var[{value:l},,{value:n},,{value:u}]=d.formatToParts(todayG);let m=u+"-"+l+"-"+n;[{value:l},,{value:n},,{value:u}]=o.formatToParts(todayG);var g=u+"-"+l+"-"+n;let h,f;1==map_settings.user.cal_compact_view&&(h="compact"),i=(i=(i=(i=(i="")+"<table id='maincalendar' cellspacing=0 cellpadding=0 class='"+h+"'>\t<colgroup>")+"\t\t<col class='col-1' span=1 width=80>\t\t<col class='col-2' span=1 width=30>")+"\t</colgroup>\t<tr>")+"\t\t<th>Rooms</th>\t\t<th>Bed</th>";for(let e=-1;e<s-1;e++){f=s<10?"bigview":s<20?"mediumview":"smallview",c.setTime(r+864e5*e),-1==e?([{value:v},,{value:_},,{value:p}]=a.formatToParts(c),view_sd=p+"-"+v+"-"+_):e==s-1-1&&([{value:p},,{value:v},,{value:_}]=a.formatToParts(c),view_ed=_+"-"+p+"-"+v);var p,v,_,[{value:k},,{value:C},,{value:S}]=o.formatToParts(c);S+"-"+k+"-"+C==g&&(f+=" header-today"),i=(i=(i=(i=(i+="<th>")+("\t<div class='days-container "+f+"'>"))+("\t\t<div class='day'>"+C+"</div>")+("\t\t<div class='month'>"+k+"</div>"))+("\t\t<div class='dow'>"+dow_long[c.getDay()]+"</div>"))+"\t</div>"+"</th>"}i+="</tr>";let b,B,L,w,E,x,T=0;for(y=0,Object.entries(e).forEach(function(e){L=e[0],b=e[1][4],B=e[1][2],w=e[1][5],x=roomsCatImg(w),E=map_rooms_cat[w],map_rooms_names.hasOwnProperty(L)||(map_rooms_names[L]=[B,w]);for(let t=1;t<=b;t++){c.setTime(r),i+="<tr>",1==t&&(i=(i=(i=(i+="<td rowspan="+b+" class='roomcell'>")+"\t<span class='flex-centered'><span>"+B+"</span><span class='smallest' style='line-height:0.5; white-space: nowrap; margin: 3px auto 5px'>"+E+"</span>")+"\t\t<img src='/assets/be/icons/"+x+"' class='filter-dred m0a' width='16' height='16'>")+"\t</span></td>"),i+="<td  id='b_"+L+"_"+t+"' class='bednum'>"+t+"</td>";for(let e=-1;e<s-1;e++){c.setTime(r+864e5*e),h="";var[{value:o},,{value:a},,{value:l}]=d.formatToParts(c),n=l+"_"+o+"_"+a+"_"+L+"_"+t,l=(t==b&&(h+=" border-bottom"),l+"-"+o+"-"+a);l==m&&(h+=" today"),i+="<td id='"+n+"' class='n cell "+h+"' data-xy='"+T+"_"+y+"'></td>",T++}i+="</tr>",y++,T=0}}),i+="</table>",0==Object.entries(e).length&&(console.log("no rooms"),document.getElementById("no_rooms_msg").hidden=0),el=document.getElementById("calendar_grid_container");el.firstChild;)el.removeChild(el.firstChild);u=parseHTML(i);return el.appendChild(u),console.timeEnd("DrawSchema"),setTimeout(function(){retrieveBookings()},100),first_draw&&(setTimeout(function(){initTableListeners()},200),first_draw=!1),!0}function callBackAfterMove(t){if(t.hasOwnProperty("d")){console.log(t.d);let e=t.d;e.includes("callBackAfterCompleteMove")?callBackAfterCompleteMove():e.includes("callBackAfterSplitMove")?callBackAfterSplitMove(t.d):e.includes("reDraw")&&drawSchema(),updateCheckinsCheckouts()}}function callBackAfterCompleteMove(){console.log("call back called");var e=otel.innerText,t=otel.dataset.tid,o=otel.dataset.bid,a=otel.dataset.cid,l=otel.dataset.state;makeBookingACell(otel),makeCellABooking(dtel,e,t,o,a),setBookingState(dtel,l),resizeABooking(dtel,1,ocol,!1,!1),getBookingBalanceFromCache(),updateCheckinsCheckouts()}function callBackAfterSplitMove(e){console.log("call back called with "+e);var t=otel.innerText,o=otel.dataset.tid,a=otel.dataset.bid,l=otel.dataset.cid,n=otel.dataset.state,e=e.split("_")[1],i=ocol-ocolm;makeCellABooking(otel,t,o,a,l),setBookingState(otel,n),resizeABooking(otel,ocol,i,!0,!1),makeCellABooking(dtel,t,e,a,l),setBookingState(dtel,n),resizeABooking(dtel,1,ocolm,!1,!1),getBookingBalanceFromCache(),updateCheckinsCheckouts()}function callBackAfterCustomerSearch(e){let t=document.getElementById("booking_add_form_results"),o=t.querySelector("ul"),a=document.getElementById("popup_calendar_1");for(;o.firstChild;)o.removeChild(o.firstChild);0==Object.keys(e).length?t.classList.add("hidden"):(t.classList.remove("hidden"),Object.entries(e).forEach(function(e){e=parseHTML("<li id='customer_result_"+e[0]+"'>"+e[1]+"</li>");o.append(e)}),a.addEventListener("mousedown",customerSearchResultClick))}function customerSearchResultClick(e){let t=document.getElementById("booking_add_form_results"),o=document.getElementById("popup_calendar_1"),a=document.getElementById("book_name");if(t.contains(e.target)){if("LI"!==e.target.nodeName)return;a.value=e.target.innerText,selected_cid=e.target.id.split("_")[2]}t.classList.add("hidden"),o.removeEventListener("mousedown",customerSearchResultClick)}function cacheAddBalanceToBids(o){cacheRemoveAllBalancesFromCalendar(),Object.keys(o).forEach(function(e){var t=o[e];0<t&&document.querySelectorAll("td.res[data-bid='"+e+"']").forEach(function(e){var t=parseHTML("<span class='balance-high'></span>");e.appendChild(t),e.classList.add("hasBalance")})})}function callBackRetrieveBookings(e){let i=new Date,s=new Intl.DateTimeFormat("en",{year:"2-digit",month:"2-digit",day:"2-digit"}),d,r,c,u,m,g,h,f,p,v,y,_;return console.time("DrawBookings"),Array.from(Object.values(e)).forEach(function(e){if(y=!1,_=!1,e.hasOwnProperty("num"))callBackCalendarLiveUpdate(e);else if(c=e[0],h=e[1],d=e[2],r=e[3],u=e[4],f=e[5],m=e[6],g=e[7],cstate=e[8],tid=e[9],0<(p=e[10])&&(_=!0),0!=h){2==h&&1==cstate&&(cstate=2),100==h&&(cstate=100);var e=parseDateISOLocal(m),t=parseDateISOLocal(view_sd),o=parseDateISOLocal(g),a=parseDateISOLocal(view_ed),l=(m=Math.max(e,t),g=Math.min(o,a),parseInt((g-m)/864e5)+1),[{value:a},,{value:o},,{value:n}]=(a<o&&(y=!0),i.setTime(m),s.formatToParts(i)),n=n+"_"+a+"_"+o+"_"+r+"_"+u;if(void 0===document.getElementById(n))return showMessage(!1,"Error retrieving booking "+d+" possibly for TZ",5),void setTimeout(function(){drawSchema()},1e4);null!=typeof(v=document.getElementById(n))&&null!=v&&(!v.classList.contains("n")||v.classList.contains("res_over")?showMessage(!1,"Error retrieving booking "+d+" Overlapped on "+v.id,5):(makeCellABooking(v,c,tid,d,f),setBookingState(v,cstate),resizeABooking(v,1,l,!1,y,_),e<t&&(i.setTime(e),[{value:a},,{value:o},,{value:n}]=s.formatToParts(i),l=n+"_"+a+"_"+o,setMetaLeftDate(v,l))))}}),console.timeEnd("DrawBookings"),updateCheckinsCheckouts(),1==map_settings.user.cal_show_occupy&&calculateAndShowOccupancy(),!0}function initTableListeners(){console.log("Initializing table listeners"),mobile?(console.log("mobile detected"),table.addEventListener("touchstart",mouseDown,!1),table.addEventListener("touchmove",touchMove,!1),table.addEventListener("touchend",mouseUp,!1)):(table.addEventListener("mousedown",mouseDown),document.addEventListener("mouseup",mouseUp),table.addEventListener("contextmenu",showContextMenu))}function keyUpAddGuestMode(e){console.log(e),27==e.keyCode&&(highlightHide(),addGuestModeHide())}function keyUpAddNightMode(e){console.log(e),27==e.keyCode&&(highlightHide(),addNightModeHide())}function mouseDown(e){if(Boolean(mobile))return!1;if(1!=e.which&&!Boolean(mobile))return!1;if(lclicked=!0,oel=e.target,oid=e.target.id,doubleClick=!1,t0=performance.now(),lastClickTime<200){var t=t0-t1;if(console.log("lastclickTime: "+lastClickTime+" Offset "+t),t<200)return void(doubleClick=!0)}if(Boolean(mobile)||table.addEventListener("mouseover",mouseOver),"SPAN"===oel.nodeName){if(oel.classList.contains("resizer")){if(resizing=!0,otel=oel.parentElement,otid=otel.id,ocol=otel.attributes.colspan.value,9==otel.dataset.state)return;max_colspan=maxCellColspan(otid),console.log("Max colspan for this: "+max_colspan),bookingOverlay(otid,!0)}else if(oel.classList.contains("dragger")){if(Boolean(dragging))return void console.log("Already Dragging");if(otel=oel.parentElement.parentElement,otid=otel.id,9==otel.dataset.state)return;if(otel.classList.contains("locked"))return locked=!0,console.log("Locked element"),void otel.classList.add("overlay");dragging=!0;t=parseInt(oel.id.split("_")[5]);if(ocol=parseInt(otel.attributes.colspan.value),e.ctrlKey)return a=otel.dataset.bid,l=otel.dataset.cid,void(e.shiftKey?(console.log("That's a Control+Shift Click"),ctrlShiftClick=!0,highlightReservationShow(a)):(console.log("That's a Control Click"),ctrlClick=!0,highlightCustomerShow(l)));if(ocolw=otel.offsetWidth/ocol,(ocolm=ocol-t)<=0)return;for(var o=t;o<ocol;o++)document.getElementById(otid+"_"+o).classList.add("overlay");createMovingDiv(e,otel.offsetWidth*(ocol-t)/ocol,otel.offsetHeight,otel,t)}}else{if("TD"!==oel.nodeName)return!1;if(oel.classList.contains("n-add")){if(!add_guest_mode&&!add_night_mode)return;var a=document.querySelector("td.highlighted").dataset.bid,l=document.querySelector("td.highlighted").dataset.cid,e=document.querySelector("td[data-bid='"+a+"']").textContent,t="&bid="+a+"&oid="+oid+"&cid="+l+"&name="+e;return void(add_guest_mode?postHttpReq("calendar_booking_add_guest",t):add_night_mode&&postHttpReq("calendar_booking_add_night",t))}if(!oel.classList.contains("n"))return!1;oel.classList.add("highlight"),selecting=!0,otel=oel,otid=oid,selected=[otid]}a=otid.split("_"),orid=parseInt(a[3]),[x0,y0]=getxy(oel)}function mouseMoveDragging(e){if(e.offsetX<ocolw)return!1;Boolean(mobile)&&(e.preventDefault(),e.stopPropagation());e=e.pageX+5;document.getElementById("moving_div").style.left=e+"px"}function touchMove(e){if(1<e.touches.length)return!1;e.preventDefault();var t=e.touches[0];ptel=document.elementFromPoint(t.pageX,t.pageY),ptid=ptel.id,e.changedTouches;ptid!=lptid&&(lptid=ptid,console.log("Cell Changed "+ptid),mouseOverSelect(ptel,ptid))}function mouseOver(e){var t,e=e.target;if("TD"===e.nodeName){if(e.classList.contains("roomcell")||e.classList.contains("bednum"))return;t=e.id}else{if("SPAN"!==e.nodeName||!e.classList.contains("dragger"))return!1;t=e.parentElement.parentElement.id}Boolean(resizing)?mouseOverResize(e,t):Boolean(selecting)?mouseOverSelect(e,t):Boolean(dragging)&&mouseOverDragging(e,t)}function mouseOverMovingDiv(e){"SPAN"===e.target.nodeName&&e.target.classList.contains("moving-div-span")&&(console.log("over div span "+el.id),1<=e.target.id&&(e.target.parentElement.parentElement.style.zIndex=0))}function mouseOverDragging(e,t){if(dtid=t,(del=e).classList.contains("res"))return!1;var t=e.getBoundingClientRect(),o=t.top,t=t.left,a=document.getElementById("moving_div");otel.offsetWidth,ocol;a.style.top=o+"px",a.style.left=t+"px","SPAN"===e.nodeName?(a.classList.remove("valid"),a.classList.add("invalid")):e.classList.contains("n")&&(a.classList.add("valid"),a.classList.remove("invalid"))}function mouseOverResize(e,t){var o,a=!1;if([x1,y1]=getxy(e),y0!=y1||x1<x0)return!1;let l=parseInt(otel.attributes.colspan.value);0==l&&(l=1);var n=otel.innerText,i=otel.dataset.tid,s=otel.dataset.bid,d=otel.dataset.cid,r=otel.dataset.state;if(t===otid){if(a=!0,!e.classList.contains("dragger"))return!1;o=parseInt(e.id.split("_")[5])+1}else{if(!e.classList.contains("n"))return!1;o=x1-x0+1}o==l||o>max_colspan||(nd=o,makeCellABooking(otel,n,i,s,d,!1),resizeABooking(otel,l,o,a,!1),setBookingState(otel,r))}function mouseOverSelect(e,t){let o,a=!1;if(selected=[],selected_cid="",t.split("_")[3]!=orid)return!1;if("TD"!=e.nodeName||e.classList.contains("res"))return validatingSelection(selecting_valid=!1),!1;[t,e]=getxy(e),maxy=Math.max(e,y0),miny=Math.min(y0,e),maxx=Math.max(t,x0),minx=Math.min(x0,t),Array.from(document.querySelectorAll(".highlight")).forEach(function(e){e.classList.remove("highlight")});for(let t=minx;t<=maxx;t++)for(let e=miny;e<=maxy;e++)(o=table.querySelector("td.cell[data-xy='"+t+"_"+e+"']")).classList.contains("res")||o.classList.contains("res_over")?(a=!0,validatingSelection(selecting_valid=!1)):(o.classList.add("highlight"),Boolean(selecting_valid)||o.classList.add("invalid"),selected.push(o.id));Boolean(a)||validatingSelection(selecting_valid=!0)}function showContextMenu(e){var t,o,a,l,n,i,s;oel=e.target,oid=e.target.id,!(otel=getParentByType(oel,"TD",3))||otel.classList.contains("n")||!otel.classList.contains("cell")||highlighted||add_guest_mode||(t=otel.dataset.state,rightMenu=100==t?document.getElementById("right_click_menu_blocked"):document.getElementById("right_click_menu"),console.log(otel),o=otel.dataset.bid,a=otel.dataset.cid,rightMenu.style.top=e.pageY-20+"px",rightMenu.style.left=e.pageX-40+"px",rightMenu.style.bottom="auto",rightMenu.style.right="auto",rightMenu.classList.remove("hidden"),l=rightMenu.getBoundingClientRect().bottom,n=rightMenu.getBoundingClientRect().right,i=window.innerHeight,s=window.innerWidth,console.log(l+" "+i),i<l&&(rightMenu.style.bottom="2px",rightMenu.style.top="auto"),s<n&&(rightMenu.style.right="2px",rightMenu.style.left="auto"),100==t?rightMenu.querySelector("a.removeBlock").dataset.bid=o:(9!=t&&(rightMenu.querySelector("a.addGuest").dataset.oid=oid,rightMenu.querySelector("a.addGuest").dataset.bid=o,rightMenu.querySelector("a.addNight").dataset.oid=oid,rightMenu.querySelector("a.addNight").dataset.bid=o,rightMenu.querySelector("a.addNight").dataset.cid=a),rightMenu.querySelector("a.highlightReservation").dataset.bid=o,rightMenu.querySelector("a.highlightCustomer").dataset.cid=a),rightMenu.querySelector("a.showReservation").href="/workspace/booking.php?b="+oid,document.addEventListener("mousemove",closeContextMenu),e.preventDefault())}var toClose=!1;function closeContextMenu(e){e.target.id;rightMenu.contains(e.target)?toClose=!1:(toClose=!0,setTimeout(function(){toClose&&(rightMenu.classList.add("hidden"),document.removeEventListener("mousemove",closeContextMenu))},400))}function mouseUpAfterDragging(t){dragging=!1,document.getElementById("moving_div").removeEventListener("mousemove",mouseMoveDragging),oel.style.cursor="default",otel.querySelectorAll("span").forEach(function(e){e.classList.remove("overlay")}),document.getElementById("moving_div").style.display="none",document.getElementById("moving_div").hidden=1;let o=t.pageX,a=t.pageY;if(del=document.elementFromPoint(o,a),table.getElementsByTagName("td").forEach(function(e){var t=e.getBoundingClientRect();o>=t.left&&o<=t.left+e.offsetWidth&&a>=t.top&&a<=t.top+e.offsetHeight&&(dtel=e,dtid=e.id)}),del!==oel&&null!=del&&null!=typeof dtel&&null!=typeof del)if(del.id==otid)showMessage(!1,"Screen Error",7);else if(null!=dtel.dataset.xy){var t=parseInt(dtel.dataset.xy.split("_")[0]),l=parseInt(dtel.dataset.xy.split("_")[1]);let e=otel.dataset.leftDate;null!==e&&void 0!==e||(e=0);otel.innerText;var n=otel.dataset.tid,i=otel.dataset.bid,s=otel.dataset.cid;otel.dataset.state;if("SPAN"===del.nodeName){if(dtid!=otid)return;(del.id.includes("_res")||del.id.includes("_inf"))&&(del=dtel.firstElementChild.lastElementChild,console.log("Detected mouse up on res, so set delid "+del.id));var d=parseInt(oid.split("_")[5]),r=parseInt(del.id.split("_")[5]);if(0==r)return;if(r<=d)return;x1=t+r,dtel=table.querySelector("td[data-xy='"+x1+"_"+y0+"']")}else{if("TD"!==del.nodeName)return;if(!dtel.classList.contains("n"))return!1;if(l!=y0){if(max_colspan=maxCellColspan(dtid),ocolm>max_colspan)return console.log("Not enough space, moved "+ocolm+" in "+max_colspan+" space"),!1;if(ocol!=ocolm){d=ocol-ocolm;if(t<x0+d)return console.log("can't be on back date"),!1}}}r="&oid="+oid+"&otid="+otid+"&did="+del.id+"&tid="+n+"&bid="+i+"&cid="+s+"&ocol="+ocol+"&ocolm="+ocolm+"&metaleftdate="+e;postHttpReq("calendar_booking_move",r)}}function mouseUp(e){if(!Boolean(lclicked))return!1;if(lclicked=!1,Boolean(mobile)?alert("touch end "+e.target.id):table.removeEventListener("mouseover",mouseOver),t1=performance.now(),lastClickTime=t1-t0,Boolean(doubleClick)&&lastClickTime<200&&(console.log(">>> REAL DOUBLE CLICK <<<"),oel.classList.contains("dragger")&&(window.location.href="/workspace/booking.php?b="+oid)),(Boolean(ctrlClick)||Boolean(ctrlShiftClick))&&(ctrlClick=!1,ctrlShiftClick=!1,highlightHide()),Boolean(locked)&&(locked=!1,otel.classList.remove("overlay")),Boolean(selecting)){if(selecting=!1,!Boolean(selecting_valid))return validatingSelection(selecting_valid=!0),unselectAll(),!1;prepareBookPopup(),showPopup("popup_calendar_1"),unselectAll()}else if(Boolean(resizing)){resizing=!1,bookingOverlay(otid,!1);var t=otel.dataset.bid,o=otel.dataset.tid,a=otel.dataset.cid,l=otel.attributes.colspan.value;if(l==ocol)return;o="&id="+otid+"&tid="+o+"&bid="+t+"&cid="+a+"&ocol="+ocol+"&colspan="+l;console.log("Calling resize ----\x3e "+o),postHttpReq("calendar_booking_resize",o)}else Boolean(dragging)&&mouseUpAfterDragging(e);selecting=!1,resizing=!1,dragging=!1}
