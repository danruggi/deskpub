function drawSchema(){lastDrawSchema=new Date().getTime(),void 0===(schema=getCookie("schema_"+hid))||schema.length<=3||"undefined"==schema||!Boolean(useSchemaCookie)?(console.log("getting schema from DB"),postHttpReq("calendar_schema_get")):(console.log("loaded schema from cookies"),callBackDrawSchema(JSON.parse(schema)))}function retrieveBookings(){postHttpReq("calendar_retrieve_bookings",[view_sd,view_ed])}function makeCellABooking(e,t,a,i,n){e.innerText=t,e.classList.contains("n")&&(e.classList.remove("n"),e.classList.add("res")),i>0&&(e.dataset.bid=i,e.dataset.tid=a,e.dataset.cid=n)}function resizeABooking(e,t,a,i,n,o){let l=e.textContent,s=spanlist="",[r,d]=getxy(e),u=Math.min(t,a),g=Math.max(t,a),m=l,h=e.dataset.state;for(let f=0;f<a;f++)s+="1fr ",spanlist+="<span id='"+e.id+"_"+f+"' class='dragger'></span>";for(m+="<div id='"+e.id+"_grid' class='in-grid' style='grid-template-columns: "+s+"'>"+spanlist+"</div>",Boolean(n)||9==h?(e.classList.add("locked"),m+="<span id='"+e.id+"_inf' class='right infinite'></span>"):m+="<span id='"+e.id+"_res' class='right resizer'></span>",0==map_settings.user.cal_show_balance&&(o=!1),o&&100!=h&&(m+="<span class='balance-high'></span>",e.classList.add("hasBalance"));e.firstChild;)e.removeChild(e.firstChild);let v=parseHTML(m);e.appendChild(v),e.setAttribute("colspan",a);for(let p=u;p<g;p++){let $=r+p,_=table.querySelector("td.cell[data-xy='"+$+"_"+d+"']");if(null==_){drawSchema();return}if(!_.classList.contains("n"))return!1;Boolean(i)?showThisCell(_.id):hideThisCell(_.id)}}function setBookingState(e,t){0==t||(1==t?e.classList.add("s_unconfirmed"):2==t?e.classList.add("s_confirmed"):5==t?e.classList.add("s_checkedin"):9==t?e.classList.add("s_checkedout"):100==t&&e.classList.add("s_blocked")),e.dataset.state=t}function setMetaLeftDate(e,t){e.dataset.leftDate=t}function addGuestToReservation(e){rightMenuClose();let t=e.dataset.bid;if(isNaN(t))return;let a=document.querySelector("td[data-bid='"+t+"']").textContent;addGuestModeShow(t,a),highlightReservationShow(t),document.addEventListener("keyup",keyUpAddGuestMode)}function addNightToReservation(e){rightMenuClose();let t=e.dataset.bid,a=e.dataset.cid;if(!isNaN(t))addNightModeShow(a,document.querySelector("td[data-bid='"+t+"']").textContent),highlightCustomerShow(a),document.addEventListener("keyup",keyUpAddNightMode)}function highlightReservation(e){rightMenuClose();highlightReservationShow(e.dataset.bid),setTimeout(function(){highlightHide()},1e3)}function highlightReservationShow(e){highlighted=!0,document.querySelectorAll("td[data-bid='"+e+"']").forEach(function(e){e.classList.add("highlighted")})}function highlightCustomer(e){rightMenuClose();highlightCustomerShow(e.dataset.cid),setTimeout(function(){highlightHide()},1e3)}function highlightCustomerShow(e){highlighted=!0,document.querySelectorAll("td[data-cid='"+e+"']").forEach(function(e){e.classList.add("highlighted")})}function highlightHide(){highlighted=!1,document.querySelectorAll("td.highlighted").forEach(function(e){e.classList.remove("highlighted")})}function addGuestModeShow(e,t){add_guest_mode=!0,document.getElementById("add-guest-mode").classList.remove("hidden"),document.getElementById("add-guest-mode").querySelector(".book-id").innerText=hid+"-"+e+" ("+t+")",document.querySelectorAll("td.n").forEach(function(e){e.classList.remove("n"),e.classList.add("n-add")})}function addGuestModeHide(){add_guest_mode=!1,document.getElementById("add-guest-mode").classList.add("hidden"),document.removeEventListener("keyup",keyUpAddGuestMode),document.querySelectorAll("td.n-add").forEach(function(e){e.classList.remove("n-add"),e.classList.add("n")})}function addNightModeShow(e,t){add_night_mode=!0,document.getElementById("add-night-mode").classList.remove("hidden"),document.getElementById("add-night-mode").querySelector(".book-id").innerText=hid+"-"+e+" ("+t+")",document.querySelectorAll("td.n").forEach(function(e){e.classList.remove("n"),e.classList.add("n-add")})}function addNightModeHide(){add_night_mode=!1,document.getElementById("add-night-mode").classList.add("hidden"),document.removeEventListener("keyup",keyUpAddGuestMode),document.querySelectorAll("td.n-add").forEach(function(e){e.classList.remove("n-add"),e.classList.add("n")})}function maxCellColspan(e){var t,a,i,n;n=document.getElementById(e),[t,a]=getxy(n);for(var o=1;o<35&&(i=t+o,"object"==typeof(n=table.querySelector("td.cell[data-xy='"+i+"_"+a+"']"))&&null!==n&&n.classList.contains("n"));o++);return o}function makeBookingACell(e){var t=e.attributes.colspan.value;for(t>1&&resizeABooking(e,t,1,!0,!1);e.firstChild;)e.removeChild(e.firstChild);e.setAttribute("colspan",""),e.setAttribute("meta",""),e.removeAttribute("colspan"),delete e.dataset.bid,delete e.dataset.tid,delete e.dataset.cid,delete e.dataset.state,e.classList.remove("res"),e.classList.forEach(function(t){t.startsWith("s_")&&e.classList.remove(t)}),e.classList.add("n")}function hideThisCell(e){document.getElementById(e).classList.add("hidden"),document.getElementById(e).classList.add("res_over")}function showThisCell(e){document.getElementById(e).classList.remove("hidden"),document.getElementById(e).classList.remove("res_over")}function createMovingDiv(e,t,a,i,n){for(var o="",l="",s="",r=e.target.getBoundingClientRect(),d=r.top,u=r.left,g=i.textContent,m=getComputedStyle(i).backgroundColor.replace("rgb","rgba").replace(")",", .5)"),h=n;h<ocol;h++)o+="1fr ",h<=n+1&&(l+="<span id='"+h+"' class='moving-div-span'></span>");s+="<span style='margin-left: 5px;'>"+g+"</span><div class='in-grid' style='grid-template-columns: "+o+"'>"+l+"</div>";var f=document.getElementById("moving_div");f.hidden=0,f.style.display="flex",f.style.top=d+"px",f.style.left=u+"px",f.style.width=t+"px",f.style.height=a+"px",f.style.backgroundColor=m,f.addEventListener("mousemove",mouseMoveDragging)}function unselectAll(){Array.from(document.querySelectorAll(".highlight")).forEach(function(e){e.classList.remove("highlight")})}function validatingSelection(e){Boolean(e)?Array.from(document.querySelectorAll(".highlight")).forEach(function(e){e.classList.remove("invalid")}):Array.from(document.querySelectorAll(".highlight")).forEach(function(e){e.classList.add("invalid")})}function bookingOverlay(e,t){Boolean(t)?(console.log("adding overlay"),document.getElementById(e).classList.add("overlay")):(console.log("removing overlay"),document.getElementById(e).classList.remove("overlay"))}function getxy(e){let t=y=c=0,a;if("object"!=typeof e||"SPAN"!==e.nodeName&&"TD"!==e.nodeName)return[0,0];for(;!e.hasAttribute("data-xy");)if(e=e.parentElement,++c>=3)return[0,0];return[t=parseInt((a=e.dataset.xy.split("_"))[0]),y=parseInt(a[1])]}function goToday(){new Intl.DateTimeFormat("en",{year:"numeric",month:"numeric",month:"2-digit",day:"2-digit"}),centerDate.setTime(todayG.getTime()),setCookie("centerDate",centerDate.getTime(),.002),document.querySelector("#calendar_date_selector").value=centerDate.getFullYear()+"-"+String(parseInt(centerDate.getMonth())+1).padStart(2,"0")+"-"+String(parseInt(centerDate.getDate())).padStart(2,"0"),drawSchema()}function slideCal(e){centerDate.setTime(centerDate.getTime()+864e5*e),setCookie("centerDate",centerDate.getTime(),.002),document.querySelector("#calendar_date_selector").value=centerDate.getFullYear()+"-"+String(parseInt(centerDate.getMonth())+1).padStart(2,"0")+"-"+String(parseInt(centerDate.getDate())).padStart(2,"0"),drawSchema()}function newBookClick(e,t){let a=e.form,i=a.querySelector("input[name='sel']"),n=a.querySelector("input[name='sel_cid']");return i.value=selected,n.value=selected_cid,formSubmitXML(e,"calendar_booking_new",t),!1}function calendarRoomLock(e){return e.form.querySelector("input[name='sel']"),postHttpReq("calendar_room_lock","&sel="+selected),closePopup(),!1}function customerSearch(e,t){let a=t.value,i=document.getElementById("booking_add_form_results");if(a.length<3||27==e.keyCode){i.classList.add("hidden");return}let n=new FormData;n.append("val",a),n.append("q","calendar_customer_search"),postFetch(n)}function prepareBookPopup(){let e=0,t=0,a=0,i=[],n=new Date,o=new Date,l=new Intl.DateTimeFormat("en",{year:"numeric",month:"short",day:"2-digit"});selected.forEach(function(n){let o=n.split("_"),l=Date.parse("20"+o[0]+"-"+o[1]+"-"+o[2]);0==e&&(e=l),0==t&&(t=l),l<=e&&(e=l),l>=t&&(t=l),i.includes(o[4])||i.push(o[4]),a=o[3]});let s=parseInt(((t+=1728e5)-(e+=864e5))/864e5);n.setTime(e),o.setTime(t);let[{value:r},,{value:d},,{value:u}]=l.formatToParts(n),[{value:g},,{value:m},,{value:h}]=l.formatToParts(o),f=document.getElementById("popup_calendar_1"),v=f.querySelector(".book-start-date"),p=f.querySelector(".book-end-date");v.querySelector(".day").innerText=d,v.querySelector(".month").innerText=r,v.querySelector(".dow").innerText=dow_long[n.getDay()],p.querySelector(".day").innerText=m,p.querySelector(".month").innerText=g,p.querySelector(".dow").innerText=dow_long[o.getDay()];let $=map_rooms_names[a][0],_=roomsCatImg(map_rooms_names[a][1]);f.querySelector(".room-name").innerText=$,f.querySelector(".tot-nights").innerText=s,f.querySelector(".tot-guests").innerText=i.length,f.querySelector(".img-room-cat").attributes.src.value="/assets/be/icons/"+_}function getBookingBalanceFromCache(){if(0==map_settings.user.cal_show_balance)return;let e="";Array.from(document.querySelectorAll("td.res")).forEach(function(t){e+=t.dataset.bid+"_"});let t=new FormData;t.append("bidsString",e),t.append("q","calendar_cache_balance_get_all"),postFetch(t)}function cacheRemoveAllBalancesFromCalendar(){document.querySelectorAll("td.hasBalance").forEach(function(e){e.classList.remove("hasBalance");let t=e.querySelector(".balance-high");null!==t&&t.parentNode.removeChild(t)})}function bitsoCalDayClick(e){setCookie("centerDate",e.getTime(),.0035),drawSchema()}function calculateAndShowOccupancy(){if(0==map_settings.user.cal_show_occupy)return;let e=document.getElementById("maincalendar"),t=str="",a,i=getCookie("timeframe");if(!(void 0===i||isNaN(i))&&0!=i.length){Array.from(e.querySelectorAll(".occupancy")).forEach(function(e){e.remove()});for(let n=0;n<i;n++){str=(a=e.getElementsByClassName("cell")[n].id.split("_"))[0]+"_"+a[1]+"_"+a[2];let o=full=tot=0;Array.from(e.querySelectorAll("td[id^='"+str+"']")).forEach(function(e){tot++,e.classList.contains("res")||e.classList.contains("res_over")?full++:o++});t=parseHTML(t="<span class='occupancy small'><b>"+parseInt(100*full/tot)+"</b> <span class='smaller'>%</span></span>"),document.getElementsByTagName("th")[n+2].firstElementChild.appendChild(t)}}}function rightMenuClose(){document.querySelectorAll(".right-click-menu").forEach(function(e){e.classList.add("hidden")}),document.removeEventListener("mousemove",closeContextMenu)}function showHelpVideo(){}function setRoomCleanState(e,t){let a=e.split("_")[1],i=e.split("_")[2];if(!Array.from(Object.keys(map_rooms_names)).includes(a))return;let n=map_rooms_names[a][2],o="";0==n?o="rooms_cln_update_private":1==n&&(o="rooms_cln_update_dorm"),0==t&&(o="rooms_cln_set_dirty");let l=new FormData;l.append("state",t),l.append("rid",a),l.append("bed",i),l.append("rtype",n),l.append("q",o),postFetch(l)}function callBackDrawSchema(e){let t,a,i,n=new Intl.DateTimeFormat("en",{year:"numeric",month:"short",day:"2-digit"}),o=new Intl.DateTimeFormat("en",{year:"numeric",year:"2-digit",month:"numeric",month:"2-digit",day:"2-digit"}),l=new Intl.DateTimeFormat("en",{year:"numeric",month:"numeric",month:"2-digit",day:"2-digit"});a=JSON.stringify(e),Boolean(useSchemaCookie)&&setCookie("schema_"+hid,a,31),(void 0===(i=getCookie("timeframe"))||isNaN(i)||0==i.length)&&setCookie("timeframe",i=7,31),mobile&&(i=3);let s=getCookie("centerDate");void 0!==s&&!isNaN(s)&&s.length>0&&(centerDate.setTime(s),console.log("cookieCenterDate found: "+s)),console.time("DrawSchema"),console.log("centerdate: "+centerDate);let r=centerDate.getTime(),d=new Date,[{value:u},,{value:g},,{value:m}]=o.formatToParts(todayG),h=m+"-"+u+"-"+g;[{value:u},,{value:g},,{value:m}]=n.formatToParts(todayG);let f=m+"-"+u+"-"+g,v,p;1==map_settings.user.cal_compact_view&&(v="compact"),t="",t+="<table id='maincalendar' cellspacing=0 cellpadding=0 class='"+v+"'>",t+="	<colgroup>",t+="		<col class='col-1' span=1 width=80>",t+="		<col class='col-2' span=1 width=30>",t+="	</colgroup>",t+="	<tr>",t+="		<th>Rooms</th>",t+="		<th>Bed</th>";for(let $=-1;$<i-1;$++){if(p=i<10?"bigview":i<20?"mediumview":"smallview",d.setTime(r+864e5*$),-1==$){let[{value:_},,{value:S},,{value:L}]=l.formatToParts(d);view_sd=L+"-"+_+"-"+S}else if($==i-1-1){let[{value:k},,{value:C},,{value:b}]=l.formatToParts(d);view_ed=b+"-"+k+"-"+C}let[{value:E},,{value:B},,{value:w}]=n.formatToParts(d);w+"-"+E+"-"+B===f&&(p+=" header-today"),t+="<th>",t+="	<div class='days-container "+p+"'>",t+="		<div class='day'>"+B+"</div>",t+="		<div class='month'>"+E+"</div>",t+="		<div class='dow'>"+dow_long[d.getDay()]+"</div>",t+="	</div>",t+="</th>"}t+="</tr>";let T,x,A,q,D,M,I,N=0;for(y=0,Object.entries(e).forEach(function(e){A=e[0],M=e[1][1],T=e[1][4],x=e[1][2],I=roomsCatImg(q=e[1][5]),D=map_rooms_cat[q],map_rooms_names.hasOwnProperty(A)||(map_rooms_names[A]=[x,q,M]);for(let a=1;a<=T;a++){d.setTime(r),t+="<tr>",1==a&&(t+="<td rowspan="+T+" class='roomcell'>",t+="	<span class='flex-centered'><span>"+x+"</span><span class='smallest' style='line-height:0.5; white-space: nowrap; margin: 3px auto 5px'>"+D+"</span>",t+="		<img src='/assets/be/icons/"+I+"' class='filter-dred m0a' width='16' height='16'>",t+="	</span>",t+="</td>"),t+="<td  id='b_"+A+"_"+a+"' class='bednum'>"+a+"</td>";for(let n=-1;n<i-1;n++){d.setTime(r+864e5*n),v="";var[{value:l},,{value:s},,{value:u}]=o.formatToParts(d),g=u+"_"+l+"_"+s+"_"+A+"_"+a;a==T&&(v+=" border-bottom");u+"-"+l+"-"+s===h&&(v+=" today"),t+="<td id='"+g+"' class='n cell "+v+"' data-xy='"+N+"_"+y+"'></td>",N++}t+="</tr>",y++,N=0}}),t+="</table>",0==Object.entries(e).length&&(console.log("no rooms"),document.getElementById("no_rooms_msg").hidden=0),el=document.getElementById("calendar_grid_container");el.firstChild;)el.removeChild(el.firstChild);let R=parseHTML(t);return el.appendChild(R),console.timeEnd("DrawSchema"),setTimeout(function(){retrieveBookings()},100),first_draw&&(setTimeout(function(){initTableListeners()},200),first_draw=!1),!0}function callBackAfterMove(e){if(e.hasOwnProperty("d")){console.log(e.d);let t=e.d;t.includes("callBackAfterCompleteMove")?callBackAfterCompleteMove():t.includes("callBackAfterSplitMove")?callBackAfterSplitMove(e.d):t.includes("reDraw")&&drawSchema(),updateCheckinsCheckouts();return}}function callBackAfterCompleteMove(){console.log("call back called");let e=otel.innerText,t=otel.dataset.tid,a=otel.dataset.bid,i=otel.dataset.cid,n=otel.dataset.state;makeBookingACell(otel),makeCellABooking(dtel,e,t,a,i),setBookingState(dtel,n),resizeABooking(dtel,1,ocol,!1,!1),getBookingBalanceFromCache(),updateCheckinsCheckouts()}function callBackAfterSplitMove(e){console.log("call back called with "+e);let t=otel.innerText,a=otel.dataset.tid,i=otel.dataset.bid,n=otel.dataset.cid,o=otel.dataset.state,l=e.split("_")[1],s=ocol-ocolm;makeCellABooking(otel,t,a,i,n),setBookingState(otel,o),resizeABooking(otel,ocol,s,!0,!1),makeCellABooking(dtel,t,l,i,n),setBookingState(dtel,o),resizeABooking(dtel,1,ocolm,!1,!1),getBookingBalanceFromCache(),updateCheckinsCheckouts()}function callBackAfterCustomerSearch(e){let t=document.getElementById("booking_add_form_results"),a=t.querySelector("ul"),i=document.getElementById("popup_calendar_1");for(;a.firstChild;)a.removeChild(a.firstChild);if(0==Object.keys(e).length){t.classList.add("hidden");return}t.classList.remove("hidden"),Object.entries(e).forEach(function(e){let t=parseHTML("<li id='customer_result_"+e[0]+"'>"+e[1]+"</li>");a.append(t)}),i.addEventListener("mousedown",customerSearchResultClick)}function customerSearchResultClick(e){let t=document.getElementById("booking_add_form_results"),a=document.getElementById("popup_calendar_1"),i=document.getElementById("book_name");if(t.contains(e.target)){if("LI"!==e.target.nodeName)return;i.value=e.target.innerText,selected_cid=e.target.id.split("_")[2]}t.classList.add("hidden"),a.removeEventListener("mousedown",customerSearchResultClick)}function cacheAddBalanceToBids(e){cacheRemoveAllBalancesFromCalendar(),Object.keys(e).forEach(function(t){let a;e[t]>0&&document.querySelectorAll("td.res[data-bid='"+t+"']").forEach(function(e){let t=parseHTML("<span class='balance-high'></span>");e.appendChild(t),e.classList.add("hasBalance")})})}function callBackRetrieveBookings(e){let t=new Date,a=new Intl.DateTimeFormat("en",{year:"numeric",year:"2-digit",month:"numeric",month:"2-digit",day:"2-digit"}),i,n,o,l,s,r,d,u,g,m,h,f;return console.time("DrawBookings"),Array.from(Object.values(e)).forEach(function(e){if(h=!1,f=!1,e.hasOwnProperty("num")){callBackCalendarLiveUpdate(e);return}if(o=e[0],d=e[1],i=e[2],n=e[3],l=e[4],u=e[5],s=e[6],r=e[7],cstate=e[8],tid=e[9],(g=e[10])>0&&(f=!0),0==d)return;2==d&&1==cstate&&(cstate=2),100==d&&(cstate=100);let v=parseDateISOLocal(s),p=parseDateISOLocal(view_sd),$=parseDateISOLocal(r),_=parseDateISOLocal(view_ed);s=Math.max(v,p);let S=parseInt(((r=Math.min($,_))-s)/864e5)+1;$>_&&(h=!0),t.setTime(s);let[{value:L},,{value:k},,{value:C}]=a.formatToParts(t),b=C+"_"+L+"_"+k+"_"+n+"_"+l;if(void 0===document.getElementById(b)){showMessage(!1,"Error retrieving booking "+i+" possibly for TZ",5),setTimeout(function(){drawSchema()},1e4);return}if(null!=(m=document.getElementById(b))){if(!m.classList.contains("n")||m.classList.contains("res_over")){showMessage(!1,"Error retrieving booking "+i+" Overlapped on "+m.id,5);return}if(makeCellABooking(m,o,tid,i,u),setBookingState(m,cstate),resizeABooking(m,1,S,!1,h,f),v<p){t.setTime(v);let[{value:E},,{value:B},,{value:w}]=a.formatToParts(t);setMetaLeftDate(m,w+"_"+E+"_"+B)}}}),console.timeEnd("DrawBookings"),updateCheckinsCheckouts(),1==map_settings.user.cal_show_occupy&&calculateAndShowOccupancy(),!0}function initTableListeners(){console.log("Initializing table listeners"),mobile?(console.log("mobile detected"),table.addEventListener("touchstart",mouseDown,!1),table.addEventListener("touchmove",touchMove,!1),table.addEventListener("touchend",mouseUp,!1)):(table.addEventListener("mousedown",mouseDown),document.addEventListener("mouseup",mouseUp),table.addEventListener("contextmenu",showContextMenu))}function keyUpAddGuestMode(e){console.log(e),27==e.keyCode&&(highlightHide(),addGuestModeHide())}function keyUpAddNightMode(e){console.log(e),27==e.keyCode&&(highlightHide(),addNightModeHide())}function mouseDown(e){if(Boolean(mobile)||1!=e.which&&!Boolean(mobile))return!1;if(lclicked=!0,oel=e.target,oid=e.target.id,doubleClick=!1,t0=performance.now(),lastClickTime<200){let t=t0-t1;if(console.log("lastclickTime: "+lastClickTime+" Offset "+t),t<200){doubleClick=!0;return}}if(Boolean(mobile)||table.addEventListener("mouseover",mouseOver),"SPAN"===oel.nodeName){if(oel.classList.contains("resizer")){if(resizing=!0,otid=(otel=oel.parentElement).id,ocol=otel.attributes.colspan.value,9==otel.dataset.state)return;max_colspan=maxCellColspan(otid),console.log("Max colspan for this: "+max_colspan),bookingOverlay(otid,!0)}else{if(!oel.classList.contains("dragger"))return;if(Boolean(dragging)){console.log("Already Dragging");return}if(otid=(otel=oel.parentElement.parentElement).id,9==otel.dataset.state)return;if(otel.classList.contains("locked")){locked=!0,console.log("Locked element"),otel.classList.add("overlay");return}dragging=!0;let a=parseInt(oel.id.split("_")[5]);if(ocol=parseInt(otel.attributes.colspan.value),e.ctrlKey){let i=otel.dataset.bid,n=otel.dataset.cid;e.shiftKey?(console.log("That's a Control+Shift Click"),ctrlShiftClick=!0,highlightReservationShow(i)):(console.log("That's a Control Click"),ctrlClick=!0,highlightCustomerShow(n));return}if(ocolw=otel.offsetWidth/ocol,(ocolm=ocol-a)<=0)return;for(var o,l=a;l<ocol;l++)document.getElementById(otid+"_"+l).classList.add("overlay");let s;createMovingDiv(e,otel.offsetWidth*(ocol-a)/ocol,otel.offsetHeight,otel,a)}}else{if("TD"!==oel.nodeName)return!1;if(oel.classList.contains("n-add")){if(!add_guest_mode&&!add_night_mode)return;let r=document.querySelector("td.highlighted").dataset.bid,d=document.querySelector("td.highlighted").dataset.cid,u=document.querySelector("td[data-bid='"+r+"']").textContent,g="&bid="+r+"&oid="+oid+"&cid="+d+"&name="+u;add_guest_mode?postHttpReq("calendar_booking_add_guest",g):add_night_mode&&postHttpReq("calendar_booking_add_night",g);return}if(!oel.classList.contains("n"))return!1;oel.classList.add("highlight"),selecting=!0,otel=oel,selected=[otid=oid]}orid=parseInt((o=otid.split("_"))[3]),[x0,y0]=getxy(oel)}function mouseMoveDragging(e){if(e.offsetX<ocolw)return!1;Boolean(mobile)&&(e.preventDefault(),e.stopPropagation());var t=e.pageX+5;document.getElementById("moving_div").style.left=t+"px"}function touchMove(e){if(e.touches.length>1)return!1;e.preventDefault();var t=e.touches[0];ptid=(ptel=document.elementFromPoint(t.pageX,t.pageY)).id,e.changedTouches,ptid!=lptid&&(lptid=ptid,console.log("Cell Changed "+ptid),mouseOverSelect(ptel,ptid))}function mouseOver(e){var t,a=e.target;if("TD"===a.nodeName){if(a.classList.contains("roomcell")||a.classList.contains("bednum"))return;t=a.id}else{if(!("SPAN"===a.nodeName&&a.classList.contains("dragger")))return!1;t=a.parentElement.parentElement.id}Boolean(resizing)?mouseOverResize(a,t):Boolean(selecting)?mouseOverSelect(a,t):Boolean(dragging)&&mouseOverDragging(a,t)}function mouseOverMovingDiv(e){"SPAN"===e.target.nodeName&&e.target.classList.contains("moving-div-span")&&(console.log("over div span "+el.id),e.target.id>=1&&(e.target.parentElement.parentElement.style.zIndex=0))}function mouseOverDragging(e,t){if(dtid=t,del=e,e.classList.contains("res"))return!1;let a=e.getBoundingClientRect();var i=a.top,n=a.left,o=document.getElementById("moving_div");otel.offsetWidth,o.style.top=i+"px",o.style.left=n+"px","SPAN"===e.nodeName?(o.classList.remove("valid"),o.classList.add("invalid")):e.classList.contains("n")&&(o.classList.add("valid"),o.classList.remove("invalid"))}function mouseOverResize(e,t){var a,i=!1;if([x1,y1]=getxy(e),y0!=y1||x1<x0)return!1;let n=parseInt(otel.attributes.colspan.value);0==n&&(n=1);var o=otel.innerText;let l=otel.dataset.tid,s=otel.dataset.bid,r=otel.dataset.cid,d=otel.dataset.state;if(t===otid){if(i=!0,!e.classList.contains("dragger"))return!1;a=parseInt(e.id.split("_")[5])+1}else{if(!e.classList.contains("n"))return!1;a=x1-x0+1}a==n||a>max_colspan||(nd=a,makeCellABooking(otel,o,l,s,r,!1),resizeABooking(otel,n,a,i,!1),setBookingState(otel,d))}function mouseOverSelect(e,t){let a,i,n,o,l,s=!1;if(selected=[],selected_cid="",(a=(o=t.split("_"))[3])!=orid)return!1;if("TD"!=e.nodeName||e.classList.contains("res"))return selecting_valid=!1,validatingSelection(!1),!1;[i,n]=getxy(e),maxy=Math.max(n,y0),miny=Math.min(y0,n),maxx=Math.max(i,x0),minx=Math.min(x0,i),Array.from(document.querySelectorAll(".highlight")).forEach(function(e){e.classList.remove("highlight")});for(let r=minx;r<=maxx;r++)for(let d=miny;d<=maxy;d++)(l=table.querySelector("td.cell[data-xy='"+r+"_"+d+"']")).classList.contains("res")||l.classList.contains("res_over")?(s=!0,selecting_valid=!1,validatingSelection(!1)):(l.classList.add("highlight"),Boolean(selecting_valid)||l.classList.add("invalid"),selected.push(l.id));Boolean(s)||(selecting_valid=!0,validatingSelection(!0))}function showContextMenu(e){if(oel=e.target,oid=e.target.id,!(otel=getParentByType(oel,"TD",3))||!otel.classList.contains("cell")&&!otel.classList.contains("bednum")||otel.classList.contains("n")||highlighted||add_guest_mode)return;otel.classList.contains("bednum")&&(otel.dataset.state=0,otel.dataset.bid=0,otel.dataset.cid=0);let t=otel.dataset.state;rightMenu=100==t?document.getElementById("right_click_menu_blocked"):0==t?document.getElementById("right_click_menu_beds"):document.getElementById("right_click_menu");let a=otel.dataset.bid,i=otel.dataset.cid;0==t?(rightMenu.style.top=e.pageY-10+"px",rightMenu.style.left=e.pageX-10+"px"):(rightMenu.style.top=e.pageY-20+"px",rightMenu.style.left=e.pageX-40+"px"),rightMenu.style.bottom="auto",rightMenu.style.right="auto",rightMenu.classList.remove("hidden");let n=rightMenu.getBoundingClientRect().bottom,o=rightMenu.getBoundingClientRect().right,l=window.innerHeight,s=window.innerWidth;n>l&&(rightMenu.style.bottom="2px",rightMenu.style.top="auto"),o>s&&(rightMenu.style.right="2px",rightMenu.style.left="auto"),0==t?(rightMenu.querySelector("a.toClean").parentElement.classList.remove("hidden"),rightMenu.querySelector("a.isClean").parentElement.classList.remove("hidden"),otel.classList.contains("clean-0")?rightMenu.querySelector("a.toClean").parentElement.classList.add("hidden"):otel.classList.contains("clean-5")?(rightMenu.querySelector("a.isClean").parentElement.classList.add("hidden"),rightMenu.querySelector("a.toClean").parentElement.classList.add("hidden")):rightMenu.querySelector("a.isClean").parentElement.classList.add("hidden"),rightMenu.querySelector("a.toClean").dataset.rbid=oid,rightMenu.querySelector("a.isClean").dataset.rbid=oid):100==t?(rightMenu.querySelector("a.removeBlock").dataset.bid=a,rightMenu.querySelector("a.showReservation").href="/workspace/booking.php?b="+oid):(9==t||(rightMenu.querySelector("a.addGuest").dataset.oid=oid,rightMenu.querySelector("a.addGuest").dataset.bid=a,rightMenu.querySelector("a.addNight").dataset.oid=oid,rightMenu.querySelector("a.addNight").dataset.bid=a,rightMenu.querySelector("a.addNight").dataset.cid=i),rightMenu.querySelector("a.highlightReservation").dataset.bid=a,rightMenu.querySelector("a.highlightCustomer").dataset.cid=i,rightMenu.querySelector("a.showReservation").href="/workspace/booking.php?b="+oid),document.addEventListener("mousemove",closeContextMenu),e.preventDefault()}var toClose=!1;function closeContextMenu(e){e.target.id,rightMenu.contains(e.target)?toClose=!1:(toClose=!0,setTimeout(function(){toClose&&(rightMenu.classList.add("hidden"),document.removeEventListener("mousemove",closeContextMenu))},400))}function mouseUpAfterDragging(e){dragging=!1,document.getElementById("moving_div").removeEventListener("mousemove",mouseMoveDragging),oel.style.cursor="default",otel.querySelectorAll("span").forEach(function(e){e.classList.remove("overlay")}),document.getElementById("moving_div").style.display="none",document.getElementById("moving_div").hidden=1;let t=e.pageX,a=e.pageY;if(del=document.elementFromPoint(t,a),table.getElementsByTagName("td").forEach(function(e){let i=e.getBoundingClientRect();t>=i.left&&t<=i.left+e.offsetWidth&&a>=i.top&&a<=i.top+e.offsetHeight&&(dtel=e,dtid=e.id)}),del===oel||null==del)return;if(del.id==otid){showMessage(!1,"Screen Error",7);return}if(null==dtel.dataset.xy)return;let i=parseInt(dtel.dataset.xy.split("_")[0]),n=parseInt(dtel.dataset.xy.split("_")[1]),o=otel.dataset.leftDate;null==o&&(o=0),otel.innerText;let l=otel.dataset.tid,s=otel.dataset.bid,r=otel.dataset.cid;if(otel.dataset.state,"SPAN"===del.nodeName){if(dtid!=otid)return;(del.id.includes("_res")||del.id.includes("_inf"))&&(del=dtel.firstElementChild.lastElementChild,console.log("Detected mouse up on res, so set delid "+del.id));let d=parseInt(oid.split("_")[5]),u=parseInt(del.id.split("_")[5]);if(0==u||u<=d)return;x1=i+u,dtel=table.querySelector("td[data-xy='"+x1+"_"+y0+"']")}else{if("TD"!==del.nodeName)return;if(!dtel.classList.contains("n"))return!1;if(n!=y0){if(ocolm>(max_colspan=maxCellColspan(dtid)))return console.log("Not enough space, moved "+ocolm+" in "+max_colspan+" space"),!1;if(ocol!=ocolm&&i<x0+(ocol-ocolm))return console.log("can't be on back date"),!1}}postHttpReq("calendar_booking_move","&oid="+oid+"&otid="+otid+"&did="+del.id+"&tid="+l+"&bid="+s+"&cid="+r+"&ocol="+ocol+"&ocolm="+ocolm+"&metaleftdate="+o)}function mouseUp(e){if(!Boolean(lclicked))return!1;if(lclicked=!1,Boolean(mobile)?alert("touch end "+e.target.id):table.removeEventListener("mouseover",mouseOver),lastClickTime=(t1=performance.now())-t0,Boolean(doubleClick)&&lastClickTime<200&&(console.log(">>> REAL DOUBLE CLICK <<<"),oel.classList.contains("dragger")&&(window.location.href="/workspace/booking.php?b="+oid)),(Boolean(ctrlClick)||Boolean(ctrlShiftClick))&&(ctrlClick=!1,ctrlShiftClick=!1,highlightHide()),Boolean(locked)&&(locked=!1,otel.classList.remove("overlay")),Boolean(selecting)){if(selecting=!1,!Boolean(selecting_valid))return validatingSelection(selecting_valid=!0),unselectAll(),!1;prepareBookPopup(),showPopup("popup_calendar_1"),unselectAll()}else if(Boolean(resizing)){resizing=!1,bookingOverlay(otid,!1);let t=otel.dataset.bid,a=otel.dataset.tid,i=otel.dataset.cid,n=otel.attributes.colspan.value;if(n==ocol)return;let o="&id="+otid+"&tid="+a+"&bid="+t+"&cid="+i+"&ocol="+ocol+"&colspan="+n;console.log("Calling resize ----> "+o),postHttpReq("calendar_booking_resize",o)}else Boolean(dragging)&&mouseUpAfterDragging(e);selecting=!1,resizing=!1,dragging=!1}